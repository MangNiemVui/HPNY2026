<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Thi·ªáp NƒÉm M·ªõi üéÜ</title>

  <style>
    :root{
      --bg1:#ffe6f2; --bg2:#e8fbff; --bg3:#fff7da;
      --ink:#1c2240; --muted: rgba(28,34,64,.72);
      --card: rgba(255,255,255,.72); --card2: rgba(255,255,255,.55);
      --stroke: rgba(28,34,64,.10); --shadow: 0 18px 50px rgba(28,34,64,.14);
      --accent:#ff7ab6; --accent2:#7ee7ff; --danger:#ff4d6d;
      --radius: 24px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--ink);
      background:
        radial-gradient(1200px 800px at 18% 18%, rgba(255,122,182,.22), transparent 60%),
        radial-gradient(1000px 700px at 80% 25%, rgba(126,231,255,.22), transparent 58%),
        radial-gradient(900px 700px at 65% 85%, rgba(255,231,153,.25), transparent 58%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    canvas#fx{position:fixed; inset:0; width:100vw; height:100vh; display:block; pointer-events:none;}
    .sparkles{
      position:fixed; inset:0;
      background:
        radial-gradient(1.5px 1.5px at 22% 30%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.2px 1.2px at 62% 12%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.6px 1.6px at 82% 52%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.1px 1.1px at 35% 75%, rgba(255,255,255,.85) 40%, transparent 45%),
        radial-gradient(1.3px 1.3px at 12% 62%, rgba(255,255,255,.85) 40%, transparent 45%);
      opacity:.75; pointer-events:none; filter: blur(.15px); mix-blend-mode: soft-light;
    }
    .wrap{position:fixed; inset:0; display:grid; place-items:center; padding:18px;}
    .card{
      width:min(920px, 100%); border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      overflow:hidden; position:relative;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      background: linear-gradient(90deg, rgba(255,122,182,.35), rgba(126,231,255,.30));
      border-bottom: 1px solid rgba(28,34,64,.10);
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:800; letter-spacing:.2px; font-size:14px;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(28,34,64,.10);
      white-space:nowrap;
    }
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius:999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(28,34,64,.10);
      font-size:12px; color: rgba(28,34,64,.80);
      user-select:none; white-space:nowrap;
    }
    .btnMusic{
      padding: 8px 12px; border-radius:999px; border:0; cursor:pointer;
      font-weight:900; color:#fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(255,122,182,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    :root{
      --bg1:#ffe6f2; --bg2:#e8fbff; --bg3:#fff7da;
      --ink:#1c2240; --muted: rgba(28,34,64,.72);
      --card: rgba(255,255,255,.72); --card2: rgba(255,255,255,.55);
      --stroke: rgba(28,34,64,.10); --shadow: 0 18px 50px rgba(28,34,64,.14);
      --accent:#ff7ab6; --accent2:#7ee7ff; --danger:#ff4d6d;
      --radius: 24px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--ink);
      background:
        radial-gradient(1200px 800px at 18% 18%, rgba(255,122,182,.22), transparent 60%),
        radial-gradient(1000px 700px at 80% 25%, rgba(126,231,255,.22), transparent 58%),
        radial-gradient(900px 700px at 65% 85%, rgba(255,231,153,.25), transparent 58%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    canvas#fx{position:fixed; inset:0; width:100vw; height:100vh; display:block; pointer-events:none;}
    .sparkles{
      position:fixed; inset:0;
      background:
        radial-gradient(1.5px 1.5px at 22% 30%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.2px 1.2px at 62% 12%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.6px 1.6px at 82% 52%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.1px 1.1px at 35% 75%, rgba(255,255,255,.85) 40%, transparent 45%),
        radial-gradient(1.3px 1.3px at 12% 62%, rgba(255,255,255,.85) 40%, transparent 45%);
      opacity:.75; pointer-events:none; filter: blur(.15px); mix-blend-mode: soft-light;
    }
    .wrap{position:fixed; inset:0; display:grid; place-items:center; padding:12px;}
    .card{
      width:min(920px, 100%); border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      overflow:hidden; position:relative;
      display:flex; flex-direction:column;
      max-height: calc(100svh - 24px);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      background: linear-gradient(90deg, rgba(255,122,182,.35), rgba(126,231,255,.30));
      border-bottom: 1px solid rgba(28,34,64,.10);
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:800; letter-spacing:.2px; font-size:14px;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(28,34,64,.10);
      white-space:nowrap;
    }
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius:999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(28,34,64,.10);
      font-size:12px; color: rgba(28,34,64,.80);
      user-select:none; white-space:nowrap;
    }
    .btnMusic{
      padding: 8px 12px; border-radius:999px; border:0; cursor:pointer;
      font-weight:900; color:#fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(255,122,182,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    .btnMusic:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .btnMusic:active{ transform: translateY(0px) scale(.99); }

    .musicSelect{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(28,34,64,.10);
      background: rgba(255,255,255,.65);
      color: rgba(28,34,64,.85);
      font-weight: 800;
      font-size: 12px;
      outline: none;
      max-width: 220px;
    }

    .content{display:grid; grid-template-columns: 1fr; gap:14px; padding:14px; overflow:auto; -webkit-overflow-scrolling: touch; flex:1 1 auto;}
    
    @media (max-width: 520px){
      /* Mobile: full-bleed + compact music + avatar on top */
      .wrap{padding:0; place-items:stretch;}
      .card{width:100%; max-height:100svh; border-radius:0;}
      .topbar{padding:10px 12px;}
      .badge{font-size:12px}
      .pill{display:none}
      h1{font-size:28px}
      .sub{font-size:13px}
      .row{gap:8px; flex-wrap:wrap;}
      .row input, .row button, #btnWish{
        width:100%;
        flex: 1 1 100%;
      }

      /* Music bar: icons beside select */
      .actions{
        display:grid;
        grid-template-columns: 1fr auto auto auto;
        gap:8px;
        align-items:center;
        width:100%;
      }
      .musicSelect{
        width:100%;
        min-width:0;
        max-width:none;
        height:36px;
        font-size:13px;
        padding:8px 10px;
      }
      .btnMusic{
        width:36px;
        height:36px;
        padding:0;
        border-radius:12px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-size:16px;
      }
      .btnMusic .txt{display:none;}

      /* Avatar: move above greeting on mobile */
      .side{order:-1; padding:4px 0 0;}
      .bubble{width: min(240px, 70vw); border-radius:20px;}
      .avatarImg{width:84%; height:84%;}

      .wishSend .row{align-items:stretch}
      textarea#wishMsg{min-height:96px}
    }

@media (min-width: 780px){
      .content{grid-template-columns: 1.05fr .95fr; align-items:center; gap:18px;}
    }
    h1{margin:6px 0; line-height:1.05; font-size: clamp(26px, 5vw, 44px);}
    .sub{margin: 0 0 14px; color: var(--muted); font-size: clamp(14px, 2.6vw, 16px); line-height: 1.5;}

    .wishBox{
      padding:14px; border-radius:18px;
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(28,34,64,.10);
    }
    .wish{font-size: clamp(15px, 3.2vw, 18px); line-height: 1.5; margin:0; min-height:56px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    input{
      flex:1 1 160px; min-width:160px;
      padding:12px 12px; border-radius:14px;
      border: 1px solid rgba(28,34,64,.14);
      background: rgba(255,255,255,.75);
      color: var(--ink); outline:none;
    }
    input::placeholder{color: rgba(28,34,64,.55)}
    input:disabled{opacity:.6; cursor:not-allowed;}
    button{
      padding:12px 14px; border-radius:14px; border:0; cursor:pointer;
      font-weight:900; color:#fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(255,122,182,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    button:active{ transform: translateY(0px) scale(.99); }
    button:disabled{opacity:.55; cursor:not-allowed; transform:none; filter:none;}

    .side{display:flex; align-items:center; justify-content:center; padding:6px 0 0;}
    .bubble{
      width: min(340px, 82vw); aspect-ratio: 1/1;
      border-radius:24px;
      background: radial-gradient(220px 220px at 30% 30%, rgba(255,122,182,.20), rgba(255,255,255,.35));
      border: 1px solid rgba(28,34,64,.10);
      display:grid; place-items:center;
      position:relative; overflow:hidden;
    }
    .blob{
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 30% 35%, rgba(126,231,255,.28), transparent 40%),
        radial-gradient(circle at 70% 60%, rgba(255,122,182,.24), transparent 40%),
        radial-gradient(circle at 60% 20%, rgba(255,231,153,.25), transparent 45%);
      filter: blur(14px);
      animation: floaty 5s ease-in-out infinite;
    }
    @keyframes floaty{0%,100%{transform:translate(-2%,-1%) rotate(-2deg)} 50%{transform:translate(2%,1%) rotate(2deg)}}
    .avatarImg{
      position: relative;
      width: 78%; height: 78%;
      border-radius: 999px;
      object-fit: cover;
      border: 1px solid rgba(28,34,64,.10);
      box-shadow: 0 10px 25px rgba(28,34,64,.10);
      background: rgba(255,255,255,.75);
    }

    .foot{
      padding: 0 18px 16px;
      color: rgba(28,34,64,.68);
      font-size: 12px;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .toggle{display:inline-flex; align-items:center; gap:8px; user-select:none; white-space:nowrap;}
    .toggle input{ width: 18px; height: 18px; }
    .year{
      font-weight: 950;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .lock{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(28,34,64,.10);
      z-index: 20;
    }
    .lockPanel{
      width: min(600px, 100%);
      border-radius: 20px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 50px rgba(28,34,64,.16);
      padding: 16px;
    }
    .lockTitle{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:8px;}
    .lockTitle h2{margin:0; font-size:18px; letter-spacing:.2px;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius:999px;
      border: 1px solid rgba(28,34,64,.12);
      background: rgba(255,255,255,.65);
      font-size: 12px; color: rgba(28,34,64,.75);
      white-space:nowrap;
    }
    .mini{font-size:12px; color: rgba(28,34,64,.68); line-height:1.45; margin:0 0 10px;}
    .status{
      margin-top:10px;
      padding:10px 12px; border-radius:14px;
      border: 1px solid rgba(28,34,64,.12);
      background: rgba(255,255,255,.72);
      font-size: 13px; color: rgba(28,34,64,.85);
      min-height: 42px; display:flex; align-items:center; gap:10px;
    }
    .status.bad{
      border-color: rgba(255,77,109,.35);
      background: rgba(255,77,109,.08);
      color: rgba(155, 20, 55, .95);
    }
    .row2{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .btnSecondary{background: rgba(28,34,64,.10); color: rgba(28,34,64,.85); box-shadow:none;}
    .btnDanger{background: linear-gradient(90deg, var(--danger), #ff9a7a);}

    .selectWrap{position:relative; flex: 1 1 280px; min-width:260px;}
    .selectBtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border: 1px solid rgba(28,34,64,.14);
      background: rgba(255,255,255,.75);
      color: var(--ink);
      cursor:pointer;
      font-weight:700;
    }
    .selectBtn small{font-weight:600; color: rgba(28,34,64,.55)}
    .menu{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 40px rgba(28,34,64,.18);
      overflow:hidden;
      z-index: 50;
    }
    .menuHead{padding:10px; border-bottom: 1px solid rgba(28,34,64,.10); background: rgba(255,255,255,.85);}
    .menuList{max-height: 260px; overflow:auto;}
    .item{
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
    }
    .item:hover{ background: rgba(126,231,255,.18); }
    .item .left{display:flex; flex-direction:column; gap:2px;}
    .item .name{font-weight:800;}
    .item .meta{font-size:12px; color: rgba(28,34,64,.62);}
    .item .tag{
      font-size: 11px; font-weight:800;
      padding: 6px 8px; border-radius:999px;
      border: 1px solid rgba(28,34,64,.10);
      background: rgba(255,255,255,.8);
      color: rgba(28,34,64,.78);
      white-space:nowrap;
    }
    .hidden{display:none !important;}

    .tapAudio{
      position:fixed; inset:0;
      display:grid; place-items:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 999;
      padding: 18px;
    }
    .tapCard{
      width: min(420px, 92vw);
      border-radius: 20px;
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 50px rgba(28,34,64,.18);
      padding: 16px;
      text-align:center;
    }
    .tapTitle{font-weight:950; font-size:18px; margin-bottom:6px;}
    .tapSub{font-size:13px; color: rgba(28,34,64,.72); line-height:1.45; margin-bottom:12px;}
    .tapBtn{
      display:inline-block;
      padding: 10px 14px;
      border-radius: 999px;
      color:#fff;
      font-weight:950;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(255,122,182,.18);
    }
  
    /* --- Wish send box --- */
    .wishSend{margin-top:14px;padding:12px;border:1px solid rgba(28,34,64,.10);border-radius:16px;background:rgba(255,255,255,.70)}
    .wishSendHead{font-weight:800;margin-bottom:8px}
    .wishSend textarea{width:100%;resize:vertical;min-height:88px;border-radius:14px;border:1px solid rgba(28,34,64,.16);padding:10px 12px;font:inherit;outline:none}
    .wishSend textarea:focus{border-color:rgba(255,122,182,.65);box-shadow:0 0 0 4px rgba(255,122,182,.18)}
    .muted{opacity:.75}

    /* --- Owner modal --- */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal.hidden{display:none}
    .modalCard{width:min(980px,100%);max-height:82vh;overflow:auto;background:#fff;border-radius:20px;padding:14px;box-shadow:0 22px 60px rgba(0,0,0,.25)}
    .modalHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .modalTitle{font-weight:900;font-size:16px}
    .modalBtns{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
    .modalBody{font-size:14px;line-height:1.45}
    .ownerRow{border:1px solid rgba(28,34,64,.10);border-radius:16px;padding:10px 12px;margin:10px 0}
    .ownerMeta{opacity:.78;font-size:12px;margin-bottom:6px}
    .pillMini{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(126,231,255,.25);border:1px solid rgba(126,231,255,.45);font-size:12px}

 1px solid rgba(28,34,64,.10);
      background: rgba(255,255,255,.65);
      color: rgba(28,34,64,.85);
      font-weight: 800;
      font-size: 12px;
      outline: none;
      max-width: 220px;
    }

    .content{display:grid; grid-template-columns: 1fr; gap:14px; padding:18px;}
    @media (min-width: 780px){
      .content{grid-template-columns: 1.05fr .95fr; align-items:center; gap:18px;}
    }
    h1{margin:6px 0; line-height:1.05; font-size: clamp(26px, 5vw, 44px);}
    .sub{margin: 0 0 14px; color: var(--muted); font-size: clamp(14px, 2.6vw, 16px); line-height: 1.5;}

    .wishBox{
      padding:14px; border-radius:18px;
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(28,34,64,.10);
    }
    .wish{font-size: clamp(15px, 3.2vw, 18px); line-height: 1.5; margin:0; min-height:56px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    input{
      flex:1 1 160px; min-width:160px;
      padding:12px 12px; border-radius:14px;
      border: 1px solid rgba(28,34,64,.14);
      background: rgba(255,255,255,.75);
      color: var(--ink); outline:none;
    }
    input::placeholder{color: rgba(28,34,64,.55)}
    input:disabled{opacity:.6; cursor:not-allowed;}
    button{
      padding:12px 14px; border-radius:14px; border:0; cursor:pointer;
      font-weight:900; color:#fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(255,122,182,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    button:active{ transform: translateY(0px) scale(.99); }
    button:disabled{opacity:.55; cursor:not-allowed; transform:none; filter:none;}

    .side{display:flex; align-items:center; justify-content:center; padding:6px 0 0;}
    .bubble{
      width: min(340px, 82vw); aspect-ratio: 1/1;
      border-radius:24px;
      background: radial-gradient(220px 220px at 30% 30%, rgba(255,122,182,.20), rgba(255,255,255,.35));
      border: 1px solid rgba(28,34,64,.10);
      display:grid; place-items:center;
      position:relative; overflow:hidden;
    }
    .blob{
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 30% 35%, rgba(126,231,255,.28), transparent 40%),
        radial-gradient(circle at 70% 60%, rgba(255,122,182,.24), transparent 40%),
        radial-gradient(circle at 60% 20%, rgba(255,231,153,.25), transparent 45%);
      filter: blur(14px);
      animation: floaty 5s ease-in-out infinite;
    }
    @keyframes floaty{0%,100%{transform:translate(-2%,-1%) rotate(-2deg)} 50%{transform:translate(2%,1%) rotate(2deg)}}
    .avatarImg{
      position: relative;
      width: 78%; height: 78%;
      border-radius: 999px;
      object-fit: cover;
      border: 1px solid rgba(28,34,64,.10);
      box-shadow: 0 10px 25px rgba(28,34,64,.10);
      background: rgba(255,255,255,.75);
    }

    .foot{
      padding: 0 18px 16px;
      color: rgba(28,34,64,.68);
      font-size: 12px;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .toggle{display:inline-flex; align-items:center; gap:8px; user-select:none; white-space:nowrap;}
    .toggle input{ width: 18px; height: 18px; }
    .year{
      font-weight: 950;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .lock{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(28,34,64,.10);
      z-index: 20;
    }
    .lockPanel{
      width: min(600px, 100%);
      border-radius: 20px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 50px rgba(28,34,64,.16);
      padding: 16px;
    }
    .lockTitle{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:8px;}
    .lockTitle h2{margin:0; font-size:18px; letter-spacing:.2px;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius:999px;
      border: 1px solid rgba(28,34,64,.12);
      background: rgba(255,255,255,.65);
      font-size: 12px; color: rgba(28,34,64,.75);
      white-space:nowrap;
    }
    .mini{font-size:12px; color: rgba(28,34,64,.68); line-height:1.45; margin:0 0 10px;}
    .status{
      margin-top:10px;
      padding:10px 12px; border-radius:14px;
      border: 1px solid rgba(28,34,64,.12);
      background: rgba(255,255,255,.72);
      font-size: 13px; color: rgba(28,34,64,.85);
      min-height: 42px; display:flex; align-items:center; gap:10px;
    }
    .status.bad{
      border-color: rgba(255,77,109,.35);
      background: rgba(255,77,109,.08);
      color: rgba(155, 20, 55, .95);
    }
    .row2{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .btnSecondary{background: rgba(28,34,64,.10); color: rgba(28,34,64,.85); box-shadow:none;}
    .btnDanger{background: linear-gradient(90deg, var(--danger), #ff9a7a);}

    .selectWrap{position:relative; flex: 1 1 280px; min-width:260px;}
    .selectBtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border: 1px solid rgba(28,34,64,.14);
      background: rgba(255,255,255,.75);
      color: var(--ink);
      cursor:pointer;
      font-weight:700;
    }
    .selectBtn small{font-weight:600; color: rgba(28,34,64,.55)}
    .menu{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 40px rgba(28,34,64,.18);
      overflow:hidden;
      z-index: 50;
    }
    .menuHead{padding:10px; border-bottom: 1px solid rgba(28,34,64,.10); background: rgba(255,255,255,.85);}
    .menuList{max-height: 260px; overflow:auto;}
    .item{
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
    }
    .item:hover{ background: rgba(126,231,255,.18); }
    .item .left{display:flex; flex-direction:column; gap:2px;}
    .item .name{font-weight:800;}
    .item .meta{font-size:12px; color: rgba(28,34,64,.62);}
    .item .tag{
      font-size: 11px; font-weight:800;
      padding: 6px 8px; border-radius:999px;
      border: 1px solid rgba(28,34,64,.10);
      background: rgba(255,255,255,.8);
      color: rgba(28,34,64,.78);
      white-space:nowrap;
    }
    .hidden{display:none !important;}

    .tapAudio{
      position:fixed; inset:0;
      display:grid; place-items:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 999;
      padding: 18px;
    }
    .tapCard{
      width: min(420px, 92vw);
      border-radius: 20px;
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 50px rgba(28,34,64,.18);
      padding: 16px;
      text-align:center;
    }
    .tapTitle{font-weight:950; font-size:18px; margin-bottom:6px;}
    .tapSub{font-size:13px; color: rgba(28,34,64,.72); line-height:1.45; margin-bottom:12px;}
    .tapBtn{
      display:inline-block;
      padding: 10px 14px;
      border-radius: 999px;
      color:#fff;
      font-weight:950;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(255,122,182,.18);
    }
  
    /* --- Wish send box --- */
    .wishSend{margin-top:14px;padding:12px;border:1px solid rgba(28,34,64,.10);border-radius:16px;background:rgba(255,255,255,.70)}
    .wishSendHead{font-weight:800;margin-bottom:8px}
    .wishSend textarea{width:100%;resize:vertical;min-height:88px;border-radius:14px;border:1px solid rgba(28,34,64,.16);padding:10px 12px;font:inherit;outline:none}
    .wishSend textarea:focus{border-color:rgba(255,122,182,.65);box-shadow:0 0 0 4px rgba(255,122,182,.18)}
    .muted{opacity:.75}

    /* --- Owner modal --- */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal.hidden{display:none}
    .modalCard{width:min(980px,100%);max-height:82vh;overflow:auto;background:#fff;border-radius:20px;padding:14px;box-shadow:0 22px 60px rgba(0,0,0,.25)}
    .modalHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .modalTitle{font-weight:900;font-size:16px}
    .modalBtns{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
    .modalBody{font-size:14px;line-height:1.45}
    .ownerRow{border:1px solid rgba(28,34,64,.10);border-radius:16px;padding:10px 12px;margin:10px 0}
    .ownerMeta{opacity:.78;font-size:12px;margin-bottom:6px}
    .pillMini{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(126,231,255,.25);border:1px solid rgba(126,231,255,.45);font-size:12px}


  /* iOS safe area */
  @supports (padding: max(0px)) {
    .wrap{padding: max(0px, env(safe-area-inset-top)) max(0px, env(safe-area-inset-right)) max(0px, env(safe-area-inset-bottom)) max(0px, env(safe-area-inset-left));}
    @media (max-width: 520px){ .wrap{padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;} }
  }
</style>
</head>

<body>
  <canvas id="fx" aria-hidden="true"></canvas>
  <div class="sparkles" aria-hidden="true"></div>

  <div class="wrap">
    <div class="card">

      <div class="lock" id="lock">
        <div class="lockPanel">
          <div class="lockTitle">
            <h2>üîí M·ªü thi·ªáp b·∫±ng T√äN + M·∫¨T KH·∫®U</h2>
            <span class="chip" id="chip">Ch∆∞a m·ªü</span>
          </div>
          <p class="mini">
            Ch·ªçn ng∆∞·ªùi c·∫ßn xem, nh·∫≠p m·∫≠t kh·∫©u r·ªìi b·∫•m <b>M·ªü thi·ªáp</b>.
            N·∫øu b·∫°n ƒëƒÉng nh·∫≠p <b>Owner</b>, b·∫°n c√≥ th·ªÉ xem thi·ªáp c·ªßa ng∆∞·ªùi kh√°c m√† kh√¥ng c·∫ßn m·∫≠t kh·∫©u c·ªßa h·ªç.
          </p>

          <div class="row2">
            <div class="selectWrap" id="selectWrap">
              <button class="selectBtn" id="selectBtn" type="button">
                <span id="selectText"><small>Ch·ªçn ng∆∞·ªùi‚Ä¶</small></span>
                <span>‚ñæ</span>
              </button>
              <div class="menu hidden" id="menu">
                <div class="menuHead">
                  <input id="search" placeholder="T√¨m t√™n ho·∫∑c key‚Ä¶" />
                </div>
                <div class="menuList" id="menuList"></div>
              </div>
            </div>

            <input id="pass" type="password" placeholder="M·∫≠t kh·∫©u" />
          </div>

          <div class="row2">
            <button id="btnUnlock">M·ªü thi·ªáp ‚ú®</button>
            <button class="btnSecondary" id="btnOwnerView" type="button" disabled>Xem thi·ªáp ng∆∞·ªùi n√†y (Owner)</button>
            <button class="btnSecondary" id="btnHint" type="button">Tip ƒë·∫∑t ·∫£nh</button>
          </div>

          <div class="row2">
            <button class="btnDanger hidden" id="btnLogout" type="button">ƒêƒÉng xu·∫•t</button>
          </div>

          <div class="row2">
            <button class="btnSecondary hidden" id="btnOwnerLogin" type="button">üîê Owner Google Login</button>
            <button class="btnSecondary hidden" id="btnOwnerLogout" type="button">üîì Owner Google Logout</button>
            <button class="btnSecondary hidden" id="btnOwnerDashboard" type="button">üìä Owner Dashboard</button>
          </div>

          <div class="status" id="status">üëâ Ch·ªçn ng∆∞·ªùi + nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
        </div>
      </div>

      <div class="topbar">
        <div class="badge" id="badge">üê¥ Thi·ªáp NƒÉm M·ªõi ‚Ä¢ Pastel Cute</div>
        <div class="actions">
          <span class="pill">Ch·∫°m / click ƒë·ªÉ b·∫Øn ph√°o hoa üéÜ</span>
          <select id="musicSelect" class="musicSelect" aria-label="Ch·ªçn nh·∫°c"></select>
          <button class="btnMusic" id="btnPrev" title="B√†i tr∆∞·ªõc">‚èÆ</button>
          <button class="btnMusic" id="btnMusic" aria-label="B·∫≠t/T·∫Øt nh·∫°c"><span class="ico" aria-hidden="true">üîä</span><span class="txt">B·∫≠t nh·∫°c</span></button>
          <button class="btnMusic" id="btnNext" title="B√†i ti·∫øp">‚è≠</button>
        </div>
      </div>

      <div class="content">
        <div>
          <h1>Ch√∫c M·ª´ng NƒÉm M·ªõi <span class="year" id="yearText">2026</span> ‚ú®</h1>
          <p class="sub" id="subLine">M·ªü kh√≥a xong b·∫°n s·∫Ω th·∫•y l·ªùi ch√∫c d√†nh ri√™ng cho b·∫°n üéÅ</p>

          <div class="wishBox">
            <p class="wish" id="wish">üîí Thi·ªáp ƒëang kh√≥a. H√£y m·ªü thi·ªáp ƒë·ªÉ xem l·ªùi ch√∫c.</p>

            <div class="row">
              <input id="viewerName" placeholder="T√™n (t·ª± ƒëi·ªÅn sau khi m·ªü)" disabled />
              <input id="yearInput" maxlength="6" inputmode="numeric" placeholder="NƒÉm (vd: 2026)" />
              <button id="btnWish" disabled>ƒê·ªïi l·ªùi ch√∫c</button>
            </div>

            <div class="wishSend">
              <div class="wishSendHead">üíå B·∫°n c√≥ mu·ªën g·ª≠i l·ªùi ch√∫c ƒë·∫øn ch·ªß s·ªü h·ªØu kh√¥ng?</div>
              <textarea id="wishMsg" rows="3" placeholder="B·∫°n h√£y nh·∫≠p v√†o ƒë√¢y g·ª≠i l·ªùi ch√∫c ƒë·∫øn ch·ªß s·ªü h·ªØu nh√©..."></textarea>
              <div class="row">
                <button class="btnSecondary" id="btnSendWish" type="button" disabled>G·ª≠i l·ªùi ch√∫c</button>
                <small class="muted" id="wishSendHint">* B·∫•m ‚ÄúG·ª≠i‚Äù ƒë·ªÉ g·ª≠i th·∫≥ng v·ªÅ Gmail ch·ªß s·ªü h·ªØu (n·∫øu ƒë√£ c·∫•u h√¨nh).</small>
              </div>
            </div>
          </div>
        </div>

        <div class="side">
          <div class="bubble">
            <div class="blob" aria-hidden="true"></div>
            <img id="avatarImg" class="avatarImg" src="avatars/default.png" alt="·∫¢nh ng∆∞·ªùi nh·∫≠n" />
          </div>
        </div>
      </div>

      <div class="foot">
        <label class="toggle">
          <input type="checkbox" id="auto" checked />
          T·ª± ƒë·ªông b·∫Øn ph√°o hoa
        </label>
        <span>Tip: b·∫≠t nh·∫°c r·ªìi ch·∫°m m√†n h√¨nh ƒë·ªÉ n·ªï d√†y h∆°n ‚ú®</span>
      </div>
    </div>
  </div>


  <!-- Owner Dashboard Modal -->
  <div id="ownerModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Owner Dashboard">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle">üìä Owner Dashboard</div>
        <div class="modalBtns">
          <button class="btnSecondary" id="btnTabViews" type="button">L∆∞·ª£t xem</button>
          <button class="btnSecondary" id="btnTabWishes" type="button">L·ªùi ch√∫c</button>
          <button class="btnSecondary" id="btnRefreshOwner" type="button">L√†m m·ªõi</button>
          <button class="btn" id="btnCloseOwner" type="button">ƒê√≥ng</button>
        </div>
      </div>
      <div id="ownerBody" class="modalBody">ƒêang t·∫£i...</div>
    </div>
  </div>

  <div id="tapAudio" class="tapAudio hidden" role="button" aria-label="Ch·∫°m ƒë·ªÉ b·∫≠t nh·∫°c">
    <div class="tapCard">
      <div class="tapTitle">üîä Ch·∫°m ƒë·ªÉ b·∫≠t nh·∫°c</div>
      <div class="tapSub">iPhone c·∫ßn thao t√°c 1 l·∫ßn ƒë·ªÉ cho ph√©p ph√°t nh·∫°c üé∂</div>
      <div class="tapBtn">Ch·∫°m ngay ‚ú®</div>
    </div>
  </div>

  <audio id="music" preload="metadata" loop playsinline webkit-playsinline></audio>

  <!-- EmailJS (send wish to owner's Gmail) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <!-- Project config (Firebase + EmailJS ids) -->
  <script src="config.js"></script>
  <!-- Services (Firebase view tracking + wish sending + owner auth) -->
  <script type="module" src="services.js"></script>

  <script>
    const yearText = document.getElementById("yearText");
    const yearInput = document.getElementById("yearInput");
    const defaultYear = new Date().getFullYear();
    yearText.textContent = String(defaultYear);
    yearInput.value = String(defaultYear);
    yearInput.addEventListener("input", () => {
      const v = yearInput.value.replace(/[^\d]/g, "").slice(0, 4);
      yearInput.value = v;
      if (v) yearText.textContent = v;
    });

    const music = document.getElementById("music");
    const btnMusic = document.getElementById("btnMusic");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const musicSelect = document.getElementById("musicSelect");
    const tapAudio = document.getElementById("tapAudio");

    let PLAYLIST = [];
    let trackIndex = 0;
    let musicOn = false;
    let userChangedTrack = false; // set true when user manually changes track

    function setMusicButton(state, label){
      // state: true = on, false = off
      const ico = btnMusic.querySelector(".ico");
      const txt = btnMusic.querySelector(".txt");
      if (!ico || !txt) {
        // fallback for old markup
        btnMusic.textContent = label || (state ? "üéµ T·∫Øt nh·∫°c" : "üîä B·∫≠t nh·∫°c");
        return;
      }
      if (label){
        // when showing errors like "‚ùó Ch∆∞a c√≥ nh·∫°c"
        ico.textContent = "‚ùó";
        txt.textContent = label.replace(/^‚ùó\s*/,'');
        return;
      }
      if (state){
        ico.textContent = "üéµ";
        txt.textContent = "T·∫Øt nh·∫°c";
      }else{
        ico.textContent = "üîä";
        txt.textContent = "B·∫≠t nh·∫°c";
      }
    }

    async function loadPlaylist(){
      try{
        const res = await fetch("music/playlist.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Cannot load music/playlist.json");
        PLAYLIST = await res.json();

        musicSelect.innerHTML = PLAYLIST.map((t, i) =>
          `<option value="${i}">${t.title}</option>`
        ).join("");

        trackIndex = getDefaultTrackIndexForViewer(null);
        userChangedTrack = false;
        setTrack(trackIndex, false);
      }catch(e){
        console.warn(e);
        PLAYLIST = [];
        musicSelect.innerHTML = `<option value="">(Kh√¥ng c√≥ playlist)</option>`;
        setMusicButton(false, "‚ùó Ch∆∞a c√≥ nh·∫°c");
      }
    }


    function getDefaultTrackIndexForViewer(viewer){
      // Default track:
      // - Anh Qu·ª≥nh (key 'ethereal') => '24h.mp4'
      // - Everyone else => keep the original default song
      const specialFile = (viewer && viewer.key === "ethereal") ? "24h.mp4" : "";
      const defaultFile = "nam-qua-da-lam-gi.mp3";

      const pickByFile = (file) => {
        if (!file || !PLAYLIST.length) return -1;
        const idx = PLAYLIST.findIndex(t => t.file === file);
        return idx >= 0 ? idx : -1;
      };

      const specialIdx = pickByFile(specialFile);
      if (specialIdx >= 0) return specialIdx;

      const defIdx = pickByFile(defaultFile);
      if (defIdx >= 0) return defIdx;

      return 0;
    }

    function applyDefaultTrackForViewer(viewer){
      // Only apply default if user hasn't manually changed track yet
      if (!PLAYLIST.length) return;
      if (userChangedTrack) return;
      const desired = getDefaultTrackIndexForViewer(viewer);
      if (Number.isInteger(desired) && desired >= 0 && desired < PLAYLIST.length){
        setTrack(desired, false);
      }
    }

    function setTrack(i, autoplay=true){
      if (!PLAYLIST.length) return;
      trackIndex = (i + PLAYLIST.length) % PLAYLIST.length;
      musicSelect.value = String(trackIndex);
      music.src = `music/${PLAYLIST[trackIndex].file}`;
      music.volume = 0.9;
      if (musicOn && autoplay) music.play().catch(()=>{});
    }

    function showTapOverlay(){ tapAudio.classList.remove("hidden"); }
    function hideTapOverlay(){ tapAudio.classList.add("hidden"); }

    async function tryPlayFromGesture(){
      if (!PLAYLIST.length) return false;
      try{
        if (!music.src) setTrack(trackIndex, false);
        await music.play();
        musicOn = true;
        setMusicButton(true);
        hideTapOverlay();
        return true;
      }catch(err){
        console.warn(err);
        return false;
      }
    }

    async function toggleMusic(){
      if (!PLAYLIST.length){
        setMusicButton(false, "‚ùó Ch∆∞a c√≥ nh·∫°c");
        return;
      }
      if (!musicOn){
        const ok = await tryPlayFromGesture();
        if (!ok){
          showTapOverlay();
          setMusicButton(false);
        }else{
          burst(innerWidth*0.5, innerHeight*0.25, 140);
        }
      }else{
        music.pause();
        musicOn = false;
        setMusicButton(false);
      }
    }

    btnMusic.addEventListener("click", toggleMusic);
    btnPrev.addEventListener("click", () => { userChangedTrack = true; setTrack(trackIndex - 1, true); });
    btnNext.addEventListener("click", () => { userChangedTrack = true; setTrack(trackIndex + 1, true); });
    musicSelect.addEventListener("change", (e) => {
      userChangedTrack = true;
      const i = parseInt(e.target.value, 10);
      if (!Number.isNaN(i)) setTrack(i, true);
    });
    // NOTE: Autoplay is blocked by modern browsers.
    // We do NOT try to auto-unlock audio on page load or first touch.
    // Music will start ONLY after the user taps the ‚ÄúB·∫≠t nh·∫°c‚Äù button.
    tapAudio.addEventListener("click", async () => {
      const ok = await tryPlayFromGesture();
      if (ok) burst(innerWidth*0.5, innerHeight*0.25, 120);
    });

    const lock = document.getElementById("lock");
    const statusEl = document.getElementById("status");
    const chip = document.getElementById("chip");
    const badge = document.getElementById("badge");
    const subLine = document.getElementById("subLine");

    const selectWrap = document.getElementById("selectWrap");
    const selectBtn = document.getElementById("selectBtn");
    const selectText = document.getElementById("selectText");
    const menu = document.getElementById("menu");
    const menuList = document.getElementById("menuList");
    const search = document.getElementById("search");

    const pass = document.getElementById("pass");
    const btnUnlock = document.getElementById("btnUnlock");
    const btnOwnerView = document.getElementById("btnOwnerView");
    const btnHint = document.getElementById("btnHint");
    const btnLogout = document.getElementById("btnLogout");

    const btnOwnerLogin = document.getElementById("btnOwnerLogin");
    const btnOwnerLogout = document.getElementById("btnOwnerLogout");
    const btnOwnerDashboard = document.getElementById("btnOwnerDashboard");

    const wishMsg = document.getElementById("wishMsg");
    const btnSendWish = document.getElementById("btnSendWish");
    const wishSendHint = document.getElementById("wishSendHint");

    const ownerModal = document.getElementById("ownerModal");
    const ownerBody = document.getElementById("ownerBody");
    const btnCloseOwner = document.getElementById("btnCloseOwner");
    const btnTabViews = document.getElementById("btnTabViews");
    const btnTabWishes = document.getElementById("btnTabWishes");
    const btnRefreshOwner = document.getElementById("btnRefreshOwner");

    let ownerTab = "views"; // 'views' | 'wishes'


    const viewerName = document.getElementById("viewerName");
    const btnWish = document.getElementById("btnWish");
    const wishEl = document.getElementById("wish");
    const avatarImg = document.getElementById("avatarImg");

    const DEFAULT_WISHES = [
      "Ch√∫c {name} nƒÉm m·ªõi {year} b√¨nh an d·ªãu d√†ng, vui nh∆∞ T·∫øt v√† may m·∫Øn ƒë·∫ßy nh√†! üå∏‚ú®",
      "NƒÉm {year} ch√∫c {name} s·ª©c kh·ªèe d·ªìi d√†o, tinh th·∫ßn ph∆°i ph·ªõi, m·ªçi th·ª© hanh th√¥ng! üí™üåà",
      "Ch√∫c {name} {year} ti·ªÅn v√†o ‚Äúr·∫πo r·∫πo‚Äù, ti·ªÅn ra ‚Äúnh·ªè gi·ªçt‚Äù th√¥i nha! üí∞üòÑ",
      "Ch√∫c {name} {year} h·ªçc g√¨ hi·ªÉu ƒë√≥, l√†m g√¨ c≈©ng t·ªõi, deadline n√†o c≈©ng qua! üìöüöÄ",
      "Ch√∫c {name} {year} r·ª±c r·ª° theo c√°ch c·ªßa ri√™ng m√¨nh, kh√¥ng c·∫ßn so s√°nh! üåüü´ß",
      "Ch√∫c {name} {year} m·ªçi d·ª± ƒë·ªãnh ƒë·ªÅu ‚Äúƒë√∫ng ti·∫øn ƒë·ªô‚Äù, m·ªçi m·ª•c ti√™u ƒë·ªÅu ‚Äúƒë√∫ng ƒë√≠ch‚Äù! ‚è≥üéØ"
    ];

    let PEOPLE = [];
    let selectedPerson = null;
    let lastWishIndex = -1;
    let session = { loggedIn:false, viewer:null, target:null };

    function setStatus(msg, bad=false){
      statusEl.textContent = msg;
      statusEl.classList.toggle("bad", !!bad);
    }

    async function ensureServices(){
      try{
        if (!window.AppServices) return;
        await window.AppServices.initFirebaseIfNeeded();
      }catch(e){}
    }

    function isOwnerRole(){
      return !!(session.loggedIn && session.viewer && session.viewer.role === "owner");
    }

    function isOwnerAuthed(){
      try{
        return window.AppServices?.isOwnerAuthed?.() === true;
      }catch{ return false; }
    }

    function updateOwnerUI(){
      const ownerRole = isOwnerRole();
      const authed = isOwnerAuthed();

      // show owner buttons only for owner role
      btnOwnerLogin.classList.toggle("hidden", !ownerRole || authed);
      btnOwnerLogout.classList.toggle("hidden", !ownerRole || !authed);
      btnOwnerDashboard.classList.toggle("hidden", !ownerRole || !authed);
    }

    function formatDuration(sec){
      sec = Math.max(0, Number(sec||0));
      const m = Math.floor(sec/60);
      const s = sec%60;
      if (m <= 0) return s + "s";
      return m + "m " + s + "s";
    }

    function fmtTime(ts){
      try{
        if (!ts) return "";
        if (typeof ts.toDate === "function") return ts.toDate().toLocaleString();
        if (ts.seconds) return new Date(ts.seconds*1000).toLocaleString();
        return new Date(ts).toLocaleString();
      }catch{ return ""; }
    }

    function openOwnerModal(){
      ownerModal.classList.remove("hidden");
      renderOwnerTab();
    }
    function closeOwnerModal(){
      ownerModal.classList.add("hidden");
    }

    async function renderOwnerTab(){
      ownerBody.textContent = "ƒêang t·∫£i...";
      await ensureServices();

      if (!isOwnerAuthed()){
        ownerBody.innerHTML = `
          <div class="ownerRow">
            <div><b>üîê B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p Google Owner</b></div>
            <div class="ownerMeta">H√£y b·∫•m ‚ÄúOwner Google Login‚Äù, ƒëƒÉng nh·∫≠p xong r·ªìi m·ªü l·∫°i Dashboard.</div>
            <div class="ownerMeta">N·∫øu b·∫°n ch∆∞a set <code>window.OWNER_UID</code> trong <code>config.js</code> v√† Rules, h√£y l·∫•y UID trong Firebase Authentication ‚Üí Users.</div>
          </div>
        `;
        return;
      }

      try{
        if (ownerTab === "views"){
          const list = await window.AppServices.getLatestViews(200);
          const ownerKey = window.OWNER_KEY || "";
          const filtered = list.filter(v => (v.ownerKey||"") === ownerKey);

          if (!filtered.length){
            ownerBody.textContent = "Ch∆∞a c√≥ l∆∞·ª£t xem n√†o.";
            return;
          }

          ownerBody.innerHTML = filtered.map(v => `
            <div class="ownerRow">
              <div class="ownerMeta">
                <span class="pillMini">üëÄ ${escapeHtml(v.viewerLabel || v.viewerKey || "·∫®n danh")}</span>
                xem thi·ªáp: <b>${escapeHtml(v.targetLabel || v.targetKey || "")}</b>
                ‚Ä¢ th·ªùi l∆∞·ª£ng: <b>${formatDuration(v.durationSec || 0)}</b>
              </div>
              <div class="ownerMeta">
                B·∫Øt ƒë·∫ßu: ${escapeHtml(fmtTime(v.startedAt))}
                ‚Ä¢ K·∫øt th√∫c: ${escapeHtml(fmtTime(v.endedAt))}
              </div>
              <div class="ownerMeta">UA: ${escapeHtml(String(v.userAgent||"").slice(0,120))}</div>
            </div>
          `).join("");
        } else {
          const list = await window.AppServices.getLatestWishes(200);
          const ownerKey = window.OWNER_KEY || "";
          const filtered = list.filter(w => (w.ownerKey||"") === ownerKey);

          if (!filtered.length){
            ownerBody.textContent = "Ch∆∞a c√≥ l·ªùi ch√∫c n√†o.";
            return;
          }

          ownerBody.innerHTML = filtered.map(w => `
            <div class="ownerRow">
              <div class="ownerMeta">
                <span class="pillMini">üíå ${escapeHtml(w.viewerLabel || w.viewerKey || "·∫®n danh")}</span>
                g·ª≠i khi ƒëang xem thi·ªáp: <b>${escapeHtml(w.targetLabel || w.targetKey || "")}</b>
                ‚Ä¢ ${escapeHtml(fmtTime(w.createdAt))}
              </div>
              <div style="white-space:pre-wrap">${escapeHtml(w.message || "")}</div>
            </div>
          `).join("");
        }
      }catch(e){
        console.warn(e);
        ownerBody.innerHTML = `
          <div class="ownerRow">
            <div><b>‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu</b></div>
            <div class="ownerMeta">Ki·ªÉm tra Firestore Rules (owner-only read), ho·∫∑c b·∫°n ch∆∞a login Google Owner.</div>
          </div>
        `;
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    async function loadPeople(){
      const res = await fetch("avatars/people.json", { cache: "no-store" });
      if (!res.ok) throw new Error("Cannot load avatars/people.json");
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("people.json must be an array");

      PEOPLE = data.map(p => ({
        key: String(p.key || "").trim(),
        label: String(p.label || "").trim(),
        pass: String(p.pass || "").trim(),
        role: String(p.role || "guest").trim(),
        exts: Array.isArray(p.exts) ? p.exts : ["jpg","png","webp","jpeg"],
        wishes: Array.isArray(p.wishes) ? p.wishes : null
      })).filter(p => p.key && p.label && p.pass);
    }

    function openMenu(){
      menu.classList.remove("hidden");
      search.value = "";
      renderMenu("");
      setTimeout(() => search.focus(), 0);
    }
    function closeMenu(){ menu.classList.add("hidden"); }

    function renderMenu(q){
      const query = (q || "").trim().toLowerCase();
      const list = PEOPLE.filter(p =>
        p.label.toLowerCase().includes(query) || p.key.toLowerCase().includes(query)
      );
      menuList.innerHTML = list.map(p => `
        <div class="item" data-key="${p.key}">
          <div class="left">
            <div class="name">${escapeHtml(p.label)}</div>
            <div class="meta">@${escapeHtml(p.key)}</div>
          </div>
          <div class="tag">${p.role === "owner" ? "OWNER" : "GUEST"}</div>
        </div>
      `).join("") || `
        <div class="item">
          <div class="left">
            <div class="name">Kh√¥ng t√¨m th·∫•y</div>
            <div class="meta">Th·ª≠ g√µ t√™n ho·∫∑c key</div>
          </div>
        </div>`;
    }

    function pickPersonByKey(key){
      const p = PEOPLE.find(x => x.key === key);
      if (!p) return;
      selectedPerson = p;
      selectText.innerHTML = `<span>${escapeHtml(p.label)} <small>(@${escapeHtml(p.key)})</small></span>`;
      closeMenu();
      btnOwnerView.disabled = !(session.loggedIn && session.viewer && session.viewer.role === "owner");
    }

    selectBtn.addEventListener("click", () => {
      if (menu.classList.contains("hidden")) openMenu();
      else closeMenu();
    });
    search.addEventListener("input", () => renderMenu(search.value));
    menuList.addEventListener("click", (e) => {
      const item = e.target.closest(".item");
      if (!item) return;
      const key = item.getAttribute("data-key");
      if (key) pickPersonByKey(key);
    });
    document.addEventListener("click", (e) => {
      if (!selectWrap.contains(e.target)) closeMenu();
    });

    function tryLoadAvatarFromCandidates(candidates){
      let i = 0;
      const tryNext = () => {
        if (i >= candidates.length){ avatarImg.src = "avatars/default.png"; return; }
        avatarImg.onerror = tryNext;
        avatarImg.src = candidates[i++];
      };
      tryNext();
    }
    function setAvatar(person){
      if (!person){ avatarImg.src = "avatars/default.png"; return; }
      const candidates = (person.exts || ["jpg","png","webp","jpeg"]).map(ext => `avatars/${person.key}.${ext}`);
      tryLoadAvatarFromCandidates(candidates);
    }

    function formatWish(template, displayName){
      const name = (displayName || "b·∫°n").trim();
      const year = (yearInput.value || yearText.textContent || defaultYear).trim();
      return template.replaceAll("{name}", name).replaceAll("{year}", year);
    }
    function getWishPoolForTarget(target){
      return (target && target.wishes && target.wishes.length) ? target.wishes : DEFAULT_WISHES;
    }
    function randomWish(pool){
      let idx;
      do { idx = Math.floor(Math.random() * pool.length); }
      while (pool.length > 1 && idx === lastWishIndex);
      lastWishIndex = idx;
      return pool[idx];
    }
    function showWish(){
      if (!session.loggedIn || !session.target) return;
      const pool = getWishPoolForTarget(session.target);
      wishEl.textContent = formatWish(randomWish(pool), session.target.label);
      burst(lastPointer.x || (innerWidth*0.5), lastPointer.y || (innerHeight*0.35), 120);
    }

    function saveSession(){ /* session persistence disabled */ }
    function restoreSession(){ return false; }

    function lockCard(msg){
      session = { loggedIn:false, viewer:null, target:null };
      // Reset music selection for next user
      userChangedTrack = false;
      try{ music.pause(); }catch(e){}
      musicOn = false;
      setMusicButton(false);
      if (PLAYLIST.length) { trackIndex = 0; setTrack(0, false); }
      // Stop tracking view session
      try{ window.AppServices?.stopView?.(); }catch(e){}

      localStorage.removeItem("card_session_v1");

      lock.classList.remove("hidden");
      chip.textContent = "Ch∆∞a m·ªü";
      badge.textContent = "üê¥ Thi·ªáp NƒÉm M·ªõi ‚Ä¢ Pastel Cute";
      subLine.textContent = "M·ªü kh√≥a xong b·∫°n s·∫Ω th·∫•y l·ªùi ch√∫c d√†nh ri√™ng cho b·∫°n üéÅ";

      viewerName.value = "";
      viewerName.disabled = true;
      btnWish.disabled = true;
      btnSendWish.disabled = true;
      wishMsg.value = "";
      wishMsg.disabled = true;
      updateOwnerUI();
      wishEl.textContent = "üîí Thi·ªáp ƒëang kh√≥a. H√£y m·ªü thi·ªáp ƒë·ªÉ xem l·ªùi ch√∫c.";
      avatarImg.src = "avatars/default.png";

      btnOwnerView.disabled = true;
      btnLogout.classList.add("hidden");
      setStatus(msg || "üëâ Ch·ªçn ng∆∞·ªùi + nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ b·∫Øt ƒë·∫ßu.", false);
    }

    function applySessionUI(){
      const v = session.viewer;
      const t = session.target;

      chip.textContent = v.role === "owner" ? "ƒê√£ m·ªü ‚Ä¢ Owner" : "ƒê√£ m·ªü";
      badge.textContent = v.role === "owner" ? "üëë Owner Mode ‚Ä¢ Pastel Cute" : "üê¥ Thi·ªáp NƒÉm M·ªõi ‚Ä¢ Pastel Cute";

      viewerName.value = t.label;
      viewerName.disabled = true;

      btnWish.disabled = false;
      btnOwnerView.disabled = !(v.role === "owner" && selectedPerson);
      btnLogout.classList.remove("hidden");

      subLine.textContent = (v.role === "owner")
        ? "üëë Owner: c√≥ th·ªÉ xem thi·ªáp ng∆∞·ªùi kh√°c (kh√¥ng c·∫ßn m·∫≠t kh·∫©u c·ªßa h·ªç)."
        : "Ch√∫c b·∫°n m·ªôt nƒÉm m·ªõi r·ª±c r·ª° v√† th·∫≠t b√¨nh an üå∏";

      setAvatar(t);
      const pool = getWishPoolForTarget(t);
      wishEl.textContent = formatWish(randomWish(pool), t.label);

      lock.classList.add("hidden");

      // Apply default music for current viewer (Anh Qu·ª≥nh has a special default track)
      applyDefaultTrackForViewer(session.viewer);
      
      // Enable wish sending
      btnSendWish.disabled = false;
      wishMsg.disabled = false;
      // Track view session (Firebase)
      try{ window.AppServices?.startView?.(session.viewer, session.target); }catch(e){}
      // Update owner buttons
      updateOwnerUI();
burst(innerWidth*0.5, innerHeight*0.28, 180);
    }

    btnUnlock.addEventListener("click", () => {
      if (!selectedPerson){ setStatus("‚ùå B·∫°n ch∆∞a ch·ªçn ng∆∞·ªùi.", true); return; }
      const pw = (pass.value || "").trim();
      if (!pw){ setStatus("‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p m·∫≠t kh·∫©u.", true); return; }
      if (pw !== selectedPerson.pass){
        setAvatar(selectedPerson);
        setStatus("‚ùå Sai m·∫≠t kh·∫©u. Th·ª≠ l·∫°i nha!", true);
        return;
      }
      session.loggedIn = true;
      session.viewer = selectedPerson;
      session.target = selectedPerson;
      setStatus("‚úÖ M·ªü thi·ªáp th√†nh c√¥ng! üéâ", false);
      applySessionUI();
    });

    btnOwnerView.addEventListener("click", () => {
      if (!session.loggedIn || !session.viewer || session.viewer.role !== "owner"){
        setStatus("‚ùå Ch·ªâ Owner m·ªõi d√πng ƒë∆∞·ª£c.", true);
        return;
      }
      if (!selectedPerson){ setStatus("‚ö†Ô∏è Ch·ªçn ng∆∞·ªùi c·∫ßn xem tr∆∞·ªõc ƒë√£.", true); return; }
      session.target = selectedPerson;
      applySessionUI();
    });

    btnLogout.addEventListener("click", () => lockCard("üëã ƒê√£ ƒëƒÉng xu·∫•t."));

    // Owner Google Login / Logout / Dashboard
    btnOwnerLogin.addEventListener("click", async () => {
      try{
        await ensureServices();
        const info = await window.AppServices.ownerGoogleLogin();
        alert("‚úÖ Owner Google Login OK\nUID: " + (info.uid || "") + "\nEmail: " + (info.email || ""));
        // Hint: set window.OWNER_UID in config.js and Firestore Rules to this UID for owner-only read
      }catch(e){
        console.warn(e);
        alert("‚ùå Owner login l·ªói. Xem Console (F12).\nN·∫øu b√°o unauthorized-domain th√¨ th√™m domain trong Authentication ‚Üí Settings ‚Üí Authorized domains.");
      }finally{
        updateOwnerUI();
      }
    });

    btnOwnerLogout.addEventListener("click", async () => {
      try{
        await window.AppServices.ownerGoogleLogout();
      }catch(e){}
      updateOwnerUI();
    });

    btnOwnerDashboard.addEventListener("click", () => openOwnerModal());
    btnCloseOwner.addEventListener("click", closeOwnerModal);
    ownerModal.addEventListener("click", (e) => { if (e.target === ownerModal) closeOwnerModal(); });

    btnTabViews.addEventListener("click", () => { ownerTab = "views"; renderOwnerTab(); });
    btnTabWishes.addEventListener("click", () => { ownerTab = "wishes"; renderOwnerTab(); });
    btnRefreshOwner.addEventListener("click", () => renderOwnerTab());

    // Send wish to owner (Firestore + EmailJS)
    btnSendWish.addEventListener("click", async () => {
      const message = (wishMsg.value || "").trim();
      if (!message){
        setStatus("‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p l·ªùi ch√∫c.", true);
        return;
      }
      try{
        btnSendWish.disabled = true;
        await ensureServices();
        const result = await window.AppServices.sendWish({
          viewerKey: session.viewer?.key || "",
          viewerLabel: session.viewer?.label || "",
          targetKey: session.target?.key || "",
          targetLabel: session.target?.label || "",
          message
        });
        wishMsg.value = "";
        if (result && result.emailed){
          setStatus("‚úÖ ƒê√£ g·ª≠i email ƒë·∫øn Gmail ch·ªß s·ªü h·ªØu! üíå", false);
        }else if (result && result.savedToFirestore){
          setStatus("‚úÖ ƒê√£ l∆∞u l·ªùi ch√∫c (ch∆∞a g·ª≠i email v√¨ ch∆∞a c·∫•u h√¨nh EmailJS).", false);
        }else{
          setStatus("‚úÖ ƒê√£ g·ª≠i! (H√£y ki·ªÉm tra c·∫•u h√¨nh EmailJS/Firebase).", false);
        }
      }catch(e){
        console.warn(e);
        setStatus("‚ö†Ô∏è G·ª≠i th·∫•t b·∫°i. Ki·ªÉm tra EmailJS/Firebase v√† Console (F12).", true);
      }finally{
        btnSendWish.disabled = false;
      }
    });

    btnWish.addEventListener("click", showWish);
    btnHint.addEventListener("click", () => {
      setStatus("Tip: ·∫¢nh ph·∫£i ƒë·∫∑t ƒë√∫ng key. V√≠ d·ª•: avatars/bethucute.jpg + b·∫Øt bu·ªôc c√≥ avatars/default.png", false);
    });

    const canvas = document.getElementById("fx");
    const ctx = canvas.getContext("2d", { alpha: true });
    let W = 0, H = 0, dpr = 1;
    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      W = Math.floor(window.innerWidth);
      H = Math.floor(window.innerHeight);
      canvas.width = Math.floor(W * dpr);
      canvas.height = Math.floor(H * dpr);
      canvas.style.width = W + "px";
      canvas.style.height = H + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resize, { passive:true });
    resize();

    const particles = [];
    const rockets = [];
    const gravity = 0.065;
    const palette = [
      [255, 122, 182],[126, 231, 255],[255, 231, 153],
      [197, 163, 255],[170, 255, 200],[255, 255, 255]
    ];
    function rand(min, max){ return Math.random() * (max - min) + min; }

    function addRocket(x, y){
      rockets.push({
        x, y: H + 20, tx: x, ty: y,
        vx: rand(-0.5, 0.5),
        vy: rand(-10.2, -8.4),
        life: 0,
        color: palette[(Math.random()*palette.length)|0],
      });
    }
    function burst(x, y, count = 90){
      const col = palette[(Math.random()*palette.length)|0];
      for (let i=0;i<count;i++){
        const a = Math.random() * Math.PI * 2;
        const sp = rand(1.1, 5.0);
        particles.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          r: rand(1.2, 2.6),
          drag: rand(0.985, 0.993),
          alpha: 1,
          fade: rand(0.010, 0.018),
          col,
          sparkle: Math.random() < 0.28
        });
      }
    }
    function drawGlow(x, y, r, col, a){
      ctx.beginPath();
      ctx.fillStyle = `rgba(${col[0]},${col[1]},${col[2]},${a})`;
      ctx.arc(x, y, r, 0, Math.PI*2);
      ctx.fill();
    }
    function fadeFrame(){
      ctx.fillStyle = "rgba(255,255,255,0.10)";
      ctx.fillRect(0, 0, W, H);
    }

    let lastPointer = {x: W*0.5, y: H*0.35};
    function pointerPos(e){
      if (e.touches && e.touches[0]) return {x: e.touches[0].clientX, y: e.touches[0].clientY};
      return {x: e.clientX, y: e.clientY};
    }
    window.addEventListener("pointerdown", (e) => {
      const p = pointerPos(e);
      lastPointer = p;
      addRocket(p.x, p.y);
    }, { passive:true });
    window.addEventListener("touchstart", (e) => {
      const p = pointerPos(e);
      lastPointer = p;
      addRocket(p.x, p.y);
    }, { passive:true });

    const autoEl = document.getElementById("auto");
    function step(){
      fadeFrame();

      if (autoEl.checked && Math.random() < (session.loggedIn ? 0.06 : 0.035)){
        addRocket(rand(W*0.12, W*0.88), rand(H*0.10, session.loggedIn ? H*0.55 : H*0.45));
      }

      for (let i=rockets.length-1;i>=0;i--){
        const r = rockets[i];
        r.life++;
        r.x += r.vx; r.y += r.vy;
        r.vy += gravity * 0.35;

        drawGlow(r.x, r.y, 2.2, r.color, 0.60);
        drawGlow(r.x, r.y, 7.2, r.color, 0.16);

        if (r.y <= r.ty || r.vy > -2.2 || r.life > 85){
          burst(r.x, r.y, (session.loggedIn ? 95 : 70) + ((Math.random()*60)|0));
          rockets.splice(i, 1);
        }
      }

      for (let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.vx *= p.drag; p.vy *= p.drag;
        p.vy += gravity;
        p.x += p.vx; p.y += p.vy;

        p.alpha -= p.fade;
        if (p.alpha <= 0 || p.y > H+40 || p.x < -40 || p.x > W+40){
          particles.splice(i, 1);
          continue;
        }
        const flick = p.sparkle ? (0.6 + Math.random()*0.7) : 1;
        drawGlow(p.x, p.y, p.r * flick, p.col, Math.max(0, p.alpha));
        drawGlow(p.x, p.y, p.r * 3.4, p.col, Math.max(0, p.alpha)*0.10);
      }

      requestAnimationFrame(step);
    }

    (async function init(){
      try{
        await loadPeople();
        renderMenu("");
        if (PEOPLE.length){
          selectedPerson = PEOPLE[0];
          selectText.innerHTML = `<span>${escapeHtml(selectedPerson.label)} <small>(@${escapeHtml(selectedPerson.key)})</small></span>`;
        }
        // Force logout on every page load
        try{ localStorage.removeItem("card_session_v1"); }catch(e){}
        lockCard("üëâ Ch·ªçn ng∆∞·ªùi + nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
      }catch(err){
        console.warn(err);
        lockCard("‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c people.json. Ki·ªÉm tra: avatars/people.json");
      }
      await loadPlaylist();

      ctx.clearRect(0,0,W,H);
      step();
      setTimeout(() => burst(W*0.5, H*0.28, 90), 350);
      try{ updateOwnerUI(); }catch(e){}
    })();
  </script>
</body>
</html>
