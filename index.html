<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Thiá»‡p NÄƒm Má»›i ğŸ†</title>

  <style>
    :root{
      --bg1:#ffe6f2; --bg2:#e8fbff; --bg3:#fff7da;
      --ink:#1c2240; --muted: rgba(28,34,64,.72);
      --card: rgba(255,255,255,.72); --card2: rgba(255,255,255,.55);
      --stroke: rgba(28,34,64,.10); --shadow: 0 18px 50px rgba(28,34,64,.14);
      --accent:#ff7ab6; --accent2:#7ee7ff; --danger:#ff4d6d;
      --radius: 24px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--ink);
      background:
        radial-gradient(1200px 800px at 18% 18%, rgba(255,122,182,.22), transparent 60%),
        radial-gradient(1000px 700px at 80% 25%, rgba(126,231,255,.22), transparent 58%),
        radial-gradient(900px 700px at 65% 85%, rgba(255,231,153,.25), transparent 58%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }

    canvas#fx{position:fixed; inset:0; width:100vw; height:100vh; display:block; pointer-events:none;}
    .sparkles{
      position:fixed; inset:0;
      background:
        radial-gradient(1.5px 1.5px at 22% 30%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.2px 1.2px at 62% 12%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.6px 1.6px at 82% 52%, rgba(255,255,255,.9) 40%, transparent 45%),
        radial-gradient(1.1px 1.1px at 35% 75%, rgba(255,255,255,.85) 40%, transparent 45%),
        radial-gradient(1.3px 1.3px at 12% 62%, rgba(255,255,255,.85) 40%, transparent 45%);
      opacity:.75; pointer-events:none; filter: blur(.15px); mix-blend-mode: soft-light;
    }

    .wrap{position:fixed; inset:0; display:grid; place-items:center; padding:12px;}
    .card{
      width:min(920px, 100%);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      max-height: calc(100svh - 24px);
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      background: linear-gradient(90deg, rgba(255,122,182,.35), rgba(126,231,255,.30));
      border-bottom: 1px solid rgba(28,34,64,.10);
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:800; letter-spacing:.2px; font-size:14px;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(28,34,64,.10);
      white-space:nowrap;
    }
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius:999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(28,34,64,.10);
      font-size:12px; color: rgba(28,34,64,.80);
      user-select:none; white-space:nowrap;
    }
    .btnMusic{
      padding: 8px 12px; border-radius:999px; border:0; cursor:pointer;
      font-weight:900; color:#fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(255,122,182,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    .btnMusic:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .btnMusic:active{ transform: translateY(0px) scale(.99); }

    .btnSecondary{
      padding: 8px 12px;
      border-radius:999px;
      border: 1px solid rgba(28,34,64,.12);
      background: rgba(255,255,255,.65);
      color: rgba(28,34,64,.85);
      box-shadow:none;
      font-weight:900;
      cursor:pointer;
    }
    .ownerBtn{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
    }

    .musicSelect{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(28,34,64,.10);
      background: rgba(255,255,255,.65);
      color: rgba(28,34,64,.85);
      font-weight: 800;
      font-size: 12px;
      outline: none;
      max-width: 220px;
    }

    .content{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex:1 1 auto;
    }
    @media (min-width: 780px){
      .content{grid-template-columns: 1.05fr .95fr; align-items:center; gap:18px;}
    }

    h1{margin:6px 0; line-height:1.05; font-size: clamp(26px, 5vw, 44px);}
    .sub{margin: 0 0 14px; color: var(--muted); font-size: clamp(14px, 2.6vw, 16px); line-height: 1.5;}

    .wishBox{
      padding:14px; border-radius:18px;
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(28,34,64,.10);
    }
    .wish{font-size: clamp(15px, 3.2vw, 18px); line-height: 1.5; margin:0; min-height:56px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    input{
      flex:1 1 160px; min-width:160px;
      padding:12px 12px; border-radius:14px;
      border: 1px solid rgba(28,34,64,.14);
      background: rgba(255,255,255,.75);
      color: var(--ink); outline:none;
    }
    input::placeholder{color: rgba(28,34,64,.55)}
    input:disabled{opacity:.6; cursor:not-allowed;}
    button{
      padding:12px 14px; border-radius:14px; border:0; cursor:pointer;
      font-weight:900; color:#fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(255,122,182,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    button:active{ transform: translateY(0px) scale(.99); }
    button:disabled{opacity:.55; cursor:not-allowed; transform:none; filter:none;}

    .side{display:flex; align-items:center; justify-content:center; padding:6px 0 0;}
    .bubble{
      width: min(340px, 82vw); aspect-ratio: 1/1;
      border-radius:24px;
      background: radial-gradient(220px 220px at 30% 30%, rgba(255,122,182,.20), rgba(255,255,255,.35));
      border: 1px solid rgba(28,34,64,.10);
      display:grid; place-items:center;
      position:relative; overflow:hidden;
    }
    .blob{
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 30% 35%, rgba(126,231,255,.28), transparent 40%),
        radial-gradient(circle at 70% 60%, rgba(255,122,182,.24), transparent 40%),
        radial-gradient(circle at 60% 20%, rgba(255,231,153,.25), transparent 45%);
      filter: blur(14px);
      animation: floaty 5s ease-in-out infinite;
    }
    @keyframes floaty{0%,100%{transform:translate(-2%,-1%) rotate(-2deg)} 50%{transform:translate(2%,1%) rotate(2deg)}}
    .avatarImg{
      position: relative;
      width: 78%; height: 78%;
      border-radius: 999px;
      object-fit: cover;
      border: 1px solid rgba(28,34,64,.10);
      box-shadow: 0 10px 25px rgba(28,34,64,.10);
      background: rgba(255,255,255,.75);
    }

    .foot{
      padding: 0 18px 16px;
      color: rgba(28,34,64,.68);
      font-size: 12px;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .toggle{display:inline-flex; align-items:center; gap:8px; user-select:none; white-space:nowrap;}
    .toggle input{ width: 18px; height: 18px; }
    .year{
      font-weight: 950;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* LOCK */
    .lock{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(28,34,64,.10);
      z-index: 20;
    }
    .lockPanel{
      width: min(620px, 100%);
      border-radius: 20px;
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 50px rgba(28,34,64,.16);
      padding: 16px;
      max-height: calc(100svh - 56px);
      overflow:auto;
    }
    .lockTitle{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px; flex-wrap:wrap; margin-bottom:8px;
    }
    .lockTitle h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      line-height:1.2;
      word-break: break-word;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius:999px;
      border: 1px solid rgba(28,34,64,.12);
      background: rgba(255,255,255,.65);
      font-size: 12px; color: rgba(28,34,64,.75);
      white-space:nowrap;
    }
    .mini{font-size:12px; color: rgba(28,34,64,.68); line-height:1.45; margin:0 0 10px;}
    .status{
      margin-top:10px;
      padding:10px 12px; border-radius:14px;
      border: 1px solid rgba(28,34,64,.12);
      background: rgba(255,255,255,.72);
      font-size: 13px; color: rgba(28,34,64,.85);
      min-height: 42px; display:flex; align-items:center; gap:10px;
    }
    .status.bad{
      border-color: rgba(255,77,109,.35);
      background: rgba(255,77,109,.08);
      color: rgba(155, 20, 55, .95);
    }
    .row2{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .btnDanger{background: linear-gradient(90deg, var(--danger), #ff9a7a);}

    .selectWrap{position:relative; flex: 1 1 280px; min-width:260px;}
    .selectBtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border: 1px solid rgba(28,34,64,.14);
      background: rgba(255,255,255,.75);
      color: var(--ink);
      cursor:pointer;
      font-weight:700;
    }
    .selectBtn small{font-weight:600; color: rgba(28,34,64,.55)}
    .menu{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 40px rgba(28,34,64,.18);
      overflow:hidden;
      z-index: 50;
    }
    .menuHead{padding:10px; border-bottom: 1px solid rgba(28,34,64,.10); background: rgba(255,255,255,.85);}
    .menuList{max-height: 260px; overflow:auto;}
    .item{
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
    }
    .item:hover{ background: rgba(126,231,255,.18); }
    .item .left{display:flex; flex-direction:column; gap:2px;}
    .item .name{font-weight:800;}
    .item .meta{font-size:12px; color: rgba(28,34,64,.62);}
    .item .tag{
      font-size: 11px; font-weight:800;
      padding: 6px 8px; border-radius:999px;
      border: 1px solid rgba(28,34,64,.10);
      background: rgba(255,255,255,.8);
      color: rgba(28,34,64,.78);
      white-space:nowrap;
    }
    .hidden{display:none !important;}

    /* Wish send */
    .wishSend{margin-top:14px;padding:12px;border:1px solid rgba(28,34,64,.10);border-radius:16px;background:rgba(255,255,255,.70)}
    .wishSendHead{font-weight:800;margin-bottom:8px}
    .wishSend textarea{width:100%;resize:vertical;min-height:88px;border-radius:14px;border:1px solid rgba(28,34,64,.16);padding:10px 12px;font:inherit;outline:none}
    .wishSend textarea:focus{border-color:rgba(255,122,182,.65);box-shadow:0 0 0 4px rgba(255,122,182,.18)}
    .muted{opacity:.75}

    /* Owner modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal.hidden{display:none}
    .modalCard{width:min(980px,100%);max-height:82vh;overflow:auto;background:#fff;border-radius:20px;padding:14px;box-shadow:0 22px 60px rgba(0,0,0,.25)}
    .modalHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .modalTitle{font-weight:900;font-size:16px}
    .modalBtns{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
    .modalBody{font-size:14px;line-height:1.45}
    .ownerRow{border:1px solid rgba(28,34,64,.10);border-radius:16px;padding:10px 12px;margin:10px 0}
    .ownerMeta{opacity:.78;font-size:12px;margin-bottom:6px}
    .pillMini{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(126,231,255,.25);border:1px solid rgba(126,231,255,.45);font-size:12px}

    /* Tap audio overlay */
    .tapAudio{
      position:fixed; inset:0;
      display:grid; place-items:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 999;
      padding: 18px;
    }
    .tapCard{
      width: min(420px, 92vw);
      border-radius: 20px;
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(28,34,64,.12);
      box-shadow: 0 18px 50px rgba(28,34,64,.18);
      padding: 16px;
      text-align:center;
    }
    .tapTitle{font-weight:950; font-size:18px; margin-bottom:6px;}
    .tapSub{font-size:13px; color: rgba(28,34,64,.72); line-height:1.45; margin-bottom:12px;}
    .tapBtn{
      display:inline-block;
      padding: 10px 14px;
      border-radius: 999px;
      color:#fff;
      font-weight:950;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(255,122,182,.18);
    }

    /* Mobile tweaks */
    @media (max-width: 520px){
      .wrap{padding:0; place-items:stretch;}
      .card{width:100%; max-height:100svh; border-radius:0;}
      .topbar{padding:10px 12px;}
      .badge{font-size:12px}
      .pill{display:none}
      .side{order:-1; padding:4px 0 0;}
      .bubble{width: min(240px, 70vw); border-radius:20px;}
      .avatarImg{width:84%; height:84%;}

      .actions{
        display:grid;
        grid-template-columns: 1fr auto auto auto;
        gap:8px;
        align-items:center;
        width:100%;
      }
      .musicSelect{
        width:100%;
        min-width:0;
        max-width:none;
        height:36px;
        font-size:13px;
        padding:8px 10px;
      }
      .btnMusic{
        width:36px;
        height:36px;
        padding:0;
        border-radius:12px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-size:16px;
      }
      .btnMusic .txt{display:none;}
      .ownerBtn{grid-column: 1 / -1; height:36px;}

      .row input, .row button, #btnWish{width:100%; flex: 1 1 100%;}
      textarea#wishMsg{min-height:96px}

      .lockPanel{max-height: calc(100svh - 24px);}
      .lockTitle h2{font-size:16px;}
      .row2 > *{width:100%; flex: 1 1 100%;}
      .selectWrap{min-width:0;}
    }

    /* iOS safe area */
    @supports (padding: max(0px)) {
      .wrap{
        padding: max(0px, env(safe-area-inset-top))
                 max(0px, env(safe-area-inset-right))
                 max(0px, env(safe-area-inset-bottom))
                 max(0px, env(safe-area-inset-left));
      }
      @media (max-width: 520px){
        .wrap{padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;}
      }
    }
  </style>
</head>

<body>
  <canvas id="fx" aria-hidden="true"></canvas>
  <div class="sparkles" aria-hidden="true"></div>

  <div class="wrap">
    <div class="card">

      <div class="lock" id="lock">
        <div class="lockPanel">
          <div class="lockTitle">
            <h2>ğŸ”’ Má»Ÿ thiá»‡p báº±ng TÃŠN + Máº¬T KHáº¨U</h2>
            <span class="chip" id="chip">ChÆ°a má»Ÿ</span>
          </div>

          <p class="mini">
            Chá»n ngÆ°á»i cáº§n xem, nháº­p máº­t kháº©u rá»“i báº¥m <b>Má»Ÿ thiá»‡p</b>.
            Náº¿u báº¡n Ä‘Äƒng nháº­p <b>Owner</b>, báº¡n cÃ³ thá»ƒ xem thiá»‡p cá»§a ngÆ°á»i khÃ¡c mÃ  khÃ´ng cáº§n máº­t kháº©u cá»§a há».
          </p>

          <div class="row2">
            <div class="selectWrap" id="selectWrap">
              <button class="selectBtn" id="selectBtn" type="button">
                <span id="selectText"><small>Chá»n ngÆ°á»iâ€¦</small></span>
                <span>â–¾</span>
              </button>
              <div class="menu hidden" id="menu">
                <div class="menuHead">
                  <input id="search" placeholder="TÃ¬m tÃªn hoáº·c keyâ€¦" />
                </div>
                <div class="menuList" id="menuList"></div>
              </div>
            </div>

            <input id="pass" type="password" placeholder="Máº­t kháº©u" />
          </div>

          <div class="row2">
            <button id="btnUnlock">Má»Ÿ thiá»‡p âœ¨</button>
            <button class="btnSecondary" id="btnOwnerView" type="button" disabled>Xem thiá»‡p ngÆ°á»i nÃ y (Owner)</button>
            <button class="btnSecondary" id="btnHint" type="button">Tip Ä‘áº·t áº£nh</button>
          </div>

          <div class="row2">
            <button class="btnDanger hidden" id="btnLogout" type="button">ÄÄƒng xuáº¥t</button>
          </div>

          <div class="status" id="status">ğŸ‘‰ Chá»n ngÆ°á»i + nháº­p máº­t kháº©u Ä‘á»ƒ báº¯t Ä‘áº§u.</div>
        </div>
      </div>

      <div class="topbar">
        <div class="badge" id="badge">ğŸ´ Thiá»‡p NÄƒm Má»›i â€¢ Pastel Cute</div>
        <div class="actions">
          <span class="pill">Cháº¡m / click Ä‘á»ƒ báº¯n phÃ¡o hoa ğŸ†</span>
          <select id="musicSelect" class="musicSelect" aria-label="Chá»n nháº¡c"></select>
          <button class="btnMusic" id="btnPrev" title="BÃ i trÆ°á»›c">â®</button>
          <button class="btnMusic" id="btnMusic" aria-label="Báº­t/Táº¯t nháº¡c">
            <span class="ico" aria-hidden="true">â–¶ï¸</span><span class="txt">PhÃ¡t nháº¡c</span>
          </button>
          <button class="btnMusic" id="btnNext" title="BÃ i tiáº¿p">â­</button>

          <button class="btnSecondary hidden ownerBtn" id="btnOwnerLogin" type="button">ğŸ” Owner Login</button>
          <button class="btnSecondary hidden ownerBtn" id="btnOwnerLogout" type="button">ğŸ”“ Owner Logout</button>
          <button class="btnSecondary hidden ownerBtn" id="btnOwnerDashboard" type="button">ğŸ“Š Dashboard</button>
        </div>
      </div>

      <div class="content">
        <div>
          <h1>ChÃºc Má»«ng NÄƒm Má»›i <span class="year" id="yearText">2026</span> âœ¨</h1>
          <p class="sub" id="subLine">Má»Ÿ khÃ³a xong báº¡n sáº½ tháº¥y lá»i chÃºc dÃ nh riÃªng cho báº¡n ğŸ</p>

          <div class="wishBox">
            <p class="wish" id="wish">ğŸ”’ Thiá»‡p Ä‘ang khÃ³a. HÃ£y má»Ÿ thiá»‡p Ä‘á»ƒ xem lá»i chÃºc.</p>

            <div class="row">
              <input id="viewerName" placeholder="TÃªn (tá»± Ä‘iá»n sau khi má»Ÿ)" disabled />
              <input id="yearInput" maxlength="6" inputmode="numeric" placeholder="NÄƒm (vd: 2026)" />
              <button id="btnWish" disabled>Äá»•i lá»i chÃºc</button>
            </div>

            <div class="wishSend">
              <div class="wishSendHead">ğŸ’Œ Báº¡n cÃ³ muá»‘n gá»­i lá»i chÃºc Ä‘áº¿n chá»§ sá»Ÿ há»¯u khÃ´ng?</div>
              <textarea id="wishMsg" rows="3" placeholder="Báº¡n hÃ£y nháº­p vÃ o Ä‘Ã¢y gá»­i lá»i chÃºc Ä‘áº¿n chá»§ sá»Ÿ há»¯u nhÃ©..."></textarea>
              <div class="row">
                <button class="btnSecondary" id="btnSendWish" type="button" disabled>Gá»­i lá»i chÃºc</button>
                <small class="muted" id="wishSendHint">* Báº¥m â€œGá»­iâ€ Ä‘á»ƒ lÆ°u Firestore + gá»­i EmailJS (náº¿u Ä‘Ã£ cáº¥u hÃ¬nh).</small>
              </div>
            </div>
          </div>
        </div>

        <div class="side">
          <div class="bubble">
            <div class="blob" aria-hidden="true"></div>
            <img id="avatarImg" class="avatarImg" src="avatars/default.png" alt="áº¢nh ngÆ°á»i nháº­n" />
          </div>
        </div>
      </div>

      <div class="foot">
        <label class="toggle">
          <input type="checkbox" id="auto" checked />
          Tá»± Ä‘á»™ng báº¯n phÃ¡o hoa
        </label>
        <span>Tip: báº­t nháº¡c rá»“i cháº¡m mÃ n hÃ¬nh Ä‘á»ƒ ná»• dÃ y hÆ¡n âœ¨</span>
      </div>
    </div>
  </div>

  <!-- Owner Dashboard Modal -->
  <div id="ownerModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Owner Dashboard">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle">ğŸ“Š Owner Dashboard</div>
        <div class="modalBtns">
          <button class="btnSecondary" id="btnTabViews" type="button">LÆ°á»£t xem</button>
          <button class="btnSecondary" id="btnTabWishes" type="button">Lá»i chÃºc</button>
          <button class="btnSecondary" id="btnRefreshOwner" type="button">LÃ m má»›i</button>
          <button class="btn" id="btnCloseOwner" type="button">ÄÃ³ng</button>
        </div>
      </div>
      <div id="ownerBody" class="modalBody">Äang táº£i...</div>
    </div>
  </div>

  <div id="tapAudio" class="tapAudio hidden" role="button" aria-label="Cháº¡m Ä‘á»ƒ báº­t nháº¡c">
    <div class="tapCard">
      <div class="tapTitle">ğŸ”Š Cháº¡m Ä‘á»ƒ báº­t nháº¡c</div>
      <div class="tapSub">iPhone cáº§n thao tÃ¡c 1 láº§n Ä‘á»ƒ cho phÃ©p phÃ¡t nháº¡c ğŸ¶</div>
      <div class="tapBtn">Cháº¡m ngay âœ¨</div>
    </div>
  </div>

  <audio id="music" preload="metadata" loop playsinline webkit-playsinline></audio>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- âœ… QUAN TRá»ŒNG: trÃªn GitHub Pages nÃªn dÃ¹ng ./ Ä‘á»ƒ khÃ´ng lá»‡ch path -->
  <script src="./config.js"></script>
  <script type="module" src="./services.js"></script>

  <script>
    // ===== Year =====
    const yearText = document.getElementById("yearText");
    const yearInput = document.getElementById("yearInput");
    const defaultYear = new Date().getFullYear();
    yearText.textContent = String(defaultYear);
    yearInput.value = String(defaultYear);
    yearInput.addEventListener("input", () => {
      const v = yearInput.value.replace(/[^\d]/g, "").slice(0, 4);
      yearInput.value = v;
      if (v) yearText.textContent = v;
    });

    // ===== Music =====
    const music = document.getElementById("music");
    const btnMusic = document.getElementById("btnMusic");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const musicSelect = document.getElementById("musicSelect");
    const tapAudio = document.getElementById("tapAudio");

    let PLAYLIST = [];
    let trackIndex = 0;
    let musicOn = false;
    let userChangedTrack = false;

    function setMusicButton(state, label){
      const ico = btnMusic.querySelector(".ico");
      const txt = btnMusic.querySelector(".txt");
      if (label){
        ico.textContent = "â—";
        txt.textContent = label.replace(/^â—\s*/,'');
        return;
      }
      if (state){ ico.textContent = "â¸"; txt.textContent = "Táº¡m dá»«ng"; }
      else { ico.textContent = "â–¶ï¸"; txt.textContent = "PhÃ¡t nháº¡c"; }
    }

    async function loadPlaylist(){
      try{
        const res = await fetch("music/playlist.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Cannot load music/playlist.json");
        PLAYLIST = await res.json();
        musicSelect.innerHTML = PLAYLIST.map((t, i) => `<option value="${i}">${t.title}</option>`).join("");
        trackIndex = 0;
        userChangedTrack = false;
        setTrack(trackIndex, false);
      }catch(e){
        console.warn(e);
        PLAYLIST = [];
        musicSelect.innerHTML = `<option value="">(KhÃ´ng cÃ³ playlist)</option>`;
        setMusicButton(false, "â— ChÆ°a cÃ³ nháº¡c");
      }
    }

    function setTrack(i, autoplay=true){
      if (!PLAYLIST.length) return;
      trackIndex = (i + PLAYLIST.length) % PLAYLIST.length;
      musicSelect.value = String(trackIndex);
      music.src = `music/${PLAYLIST[trackIndex].file}`;
      music.volume = 0.9;
      if (musicOn && autoplay) music.play().catch(()=>{});
    }
    function showTapOverlay(){ tapAudio.classList.remove("hidden"); }
    function hideTapOverlay(){ tapAudio.classList.add("hidden"); }

    async function tryPlayFromGesture(){
      if (!PLAYLIST.length) return false;
      try{
        if (!music.src) setTrack(trackIndex, false);
        await music.play();
        musicOn = true;
        setMusicButton(true);
        hideTapOverlay();
        return true;
      }catch(err){
        console.warn(err);
        return false;
      }
    }
    async function toggleMusic(){
      if (!PLAYLIST.length){ setMusicButton(false, "â— ChÆ°a cÃ³ nháº¡c"); return; }
      if (!musicOn){
        const ok = await tryPlayFromGesture();
        if (!ok){ showTapOverlay(); setMusicButton(false); }
        else { burst(innerWidth*0.5, innerHeight*0.25, 140); }
      }else{
        music.pause();
        musicOn = false;
        setMusicButton(false);
      }
    }
    btnMusic.addEventListener("click", toggleMusic);
    btnPrev.addEventListener("click", () => { userChangedTrack = true; setTrack(trackIndex - 1, true); });
    btnNext.addEventListener("click", () => { userChangedTrack = true; setTrack(trackIndex + 1, true); });
    musicSelect.addEventListener("change", (e) => {
      userChangedTrack = true;
      const i = parseInt(e.target.value, 10);
      if (!Number.isNaN(i)) setTrack(i, true);
    });
    tapAudio.addEventListener("click", async () => {
      const ok = await tryPlayFromGesture();
      if (ok) burst(innerWidth*0.5, innerHeight*0.25, 120);
    });

    // ===== UI refs =====
    const lock = document.getElementById("lock");
    const statusEl = document.getElementById("status");
    const chip = document.getElementById("chip");
    const badge = document.getElementById("badge");
    const subLine = document.getElementById("subLine");

    const selectWrap = document.getElementById("selectWrap");
    const selectBtn = document.getElementById("selectBtn");
    const selectText = document.getElementById("selectText");
    const menu = document.getElementById("menu");
    const menuList = document.getElementById("menuList");
    const search = document.getElementById("search");

    const pass = document.getElementById("pass");
    const btnUnlock = document.getElementById("btnUnlock");
    const btnOwnerView = document.getElementById("btnOwnerView");
    const btnHint = document.getElementById("btnHint");
    const btnLogout = document.getElementById("btnLogout");

    const btnOwnerLogin = document.getElementById("btnOwnerLogin");
    const btnOwnerLogout = document.getElementById("btnOwnerLogout");
    const btnOwnerDashboard = document.getElementById("btnOwnerDashboard");

    const wishMsg = document.getElementById("wishMsg");
    const btnSendWish = document.getElementById("btnSendWish");

    const ownerModal = document.getElementById("ownerModal");
    const ownerBody = document.getElementById("ownerBody");
    const btnCloseOwner = document.getElementById("btnCloseOwner");
    const btnTabViews = document.getElementById("btnTabViews");
    const btnTabWishes = document.getElementById("btnTabWishes");
    const btnRefreshOwner = document.getElementById("btnRefreshOwner");
    let ownerTab = "views";

    const viewerName = document.getElementById("viewerName");
    const btnWish = document.getElementById("btnWish");
    const wishEl = document.getElementById("wish");
    const avatarImg = document.getElementById("avatarImg");

    // ===== 40+ lá»i chÃºc random chung =====
    const GLOBAL_WISHES = [
      "ChÃºc {name} nÄƒm {year} bÃ¬nh an, vui khá»e vÃ  gáº·p nhiá»u Ä‘iá»u tá»‘t Ä‘áº¹p báº¥t ngá»! âœ¨",
      "NÄƒm {year} chÃºc {name} má»i dá»± Ä‘á»‹nh Ä‘á»u thuáº­n lá»£i, lÃ m Ä‘Ã¢u tháº¯ng Ä‘Ã³! ğŸš€",
      "ChÃºc {name} {year} tiá»n vÃ o nhÆ° nÆ°á»›c, tiá»n ra nhá» giá»t thÃ´i nha! ğŸ’°ğŸ˜„",
      "NÄƒm {year} chÃºc {name} ngá»§ ngon, Äƒn ngon, tinh tháº§n lÃºc nÃ o cÅ©ng sÃ¡ng! ğŸŒ™ğŸœ",
      "ChÃºc {name} {year} gáº·p Ä‘Ãºng ngÆ°á»i, Ä‘Ãºng viá»‡c, Ä‘Ãºng thá»i Ä‘iá»ƒm! ğŸ¯",
      "NÄƒm {year} chÃºc {name} cÆ°á»i nhiá»u hÆ¡n, lo Ã­t hÆ¡n, yÃªu Ä‘á»i hÆ¡n! ğŸ˜ŠğŸŒ·",
      "ChÃºc {name} {year} sá»©c khá»e dá»“i dÃ o, nÄƒng lÆ°á»£ng Ä‘áº§y pin cáº£ nÄƒm! ğŸ”‹ğŸ’ª",
      "NÄƒm {year} chÃºc {name} há»c gÃ¬ hiá»ƒu Ä‘Ã³, lÃ m gÃ¬ cÅ©ng tá»›i! ğŸ“šâœ…",
      "ChÃºc {name} {year} má»i deadline Ä‘á»u qua nháº¹ nhÆ° lÃ´ng há»“ng! â³ğŸª½",
      "NÄƒm {year} chÃºc {name} may máº¯n tá»›i táº¥p, niá»m vui ngáº­p trÃ n! ğŸ€ğŸ‰",
      "ChÃºc {name} {year} rá»±c rá»¡ theo cÃ¡ch cá»§a riÃªng mÃ¬nh, khÃ´ng cáº§n so sÃ¡nh! ğŸŒŸ",
      "NÄƒm {year} chÃºc {name} Ä‘i Ä‘Ã¢u cÅ©ng gáº·p Ä‘iá»u lÃ nh, vá» Ä‘Ã¢u cÅ©ng tháº¥y yÃªn! ğŸ¡âœ¨",
      "ChÃºc {name} {year} cÃ´ng viá»‡c hanh thÃ´ng, lÆ°Æ¡ng thÆ°á»Ÿng tÄƒng Ä‘á»u! ğŸ’¼ğŸ“ˆ",
      "NÄƒm {year} chÃºc {name} tÃ¬nh cáº£m áº¥m Ã¡p, gia Ä‘Ã¬nh bÃ¬nh an! ğŸ’–ğŸ«¶",
      "ChÃºc {name} {year} má»i chuyá»‡n khÃ³ rá»“i sáº½ hÃ³a dá»…! ğŸŒˆ",
      "NÄƒm {year} chÃºc {name} luÃ´n tá»± tin, máº¡nh máº½, vÃ  Ä‘Æ°á»£c yÃªu thÆ°Æ¡ng! ğŸ’ªğŸ’—",
      "ChÃºc {name} {year} sÃ¡ng táº¡o bÃ¹ng ná»•, Ã½ tÆ°á»Ÿng ra nhÆ° suá»‘i! ğŸ’¡ğŸŒŠ",
      "NÄƒm {year} chÃºc {name} Ä‘iá»m tÄ©nh trÆ°á»›c bÃ£o, bÃ¬nh yÃªn trong tim! ğŸŒ¿",
      "ChÃºc {name} {year} má»—i ngÃ y Ä‘á»u cÃ³ lÃ½ do Ä‘á»ƒ vui! ğŸ˜„âœ¨",
      "NÄƒm {year} chÃºc {name} má»Ÿ máº¯t ra lÃ  tháº¥y may máº¯n! ğŸ€ğŸ‘€",
      "ChÃºc {name} {year} gáº·p nhiá»u cÆ¡ há»™i tá»‘t, náº¯m lÃ  trÃºng! ğŸ¯ğŸ’«",
      "NÄƒm {year} chÃºc {name} Ä‘am mÃª dáº«n Ä‘Æ°á»ng, kiÃªn trÃ¬ Ä‘Æ°a tá»›i Ä‘Ã­ch! ğŸ§­ğŸ",
      "ChÃºc {name} {year} má»i káº¿ hoáº¡ch Ä‘á»u cháº¡y â€œmÆ°á»£tâ€ nhÆ° Ã½! âœ…",
      "NÄƒm {year} chÃºc {name} chill háº¿t cá»¡, vui háº¿t náº¥c! ğŸ¶ğŸ˜",
      "ChÃºc {name} {year} Ä‘i xa cÃ³ báº¡n, vá» nhÃ  cÃ³ yÃªu thÆ°Æ¡ng! ğŸ§³ğŸ’",
      "NÄƒm {year} chÃºc {name} bá»›t cÄƒng, thÃªm tháº£nh thÆ¡i! ğŸ§˜â€â™€ï¸",
      "ChÃºc {name} {year} nhá»¯ng Ä‘iá»u tá»‘t tá»± tÃ¬m Ä‘áº¿n, Ä‘iá»u xáº¥u tá»± Ä‘i láº¡c! ğŸ˜ğŸ€",
      "NÄƒm {year} chÃºc {name} yÃªu báº£n thÃ¢n nhiá»u hÆ¡n má»—i ngÃ y! ğŸ’–",
      "ChÃºc {name} {year} lÃ m gÃ¬ cÅ©ng â€œÄ‘Ãºng tiáº¿n Ä‘á»™â€, Ä‘áº¡t gÃ¬ cÅ©ng â€œÄ‘Ãºng Ä‘Ã­châ€! â³ğŸ¯",
      "NÄƒm {year} chÃºc {name} mÆ°a cÅ©ng hÃ³a náº¯ng, buá»“n cÅ©ng hÃ³a vui! â˜”â˜€ï¸",
      "ChÃºc {name} {year} tinh tháº§n vá»¯ng vÃ ng, trÃ¡i tim áº¥m Ã¡p! â¤ï¸â€ğŸ”¥",
      "NÄƒm {year} chÃºc {name} má»i sá»± nháº¹ nhÃ ng nhÆ° giÃ³, dá»‹u dÃ ng nhÆ° mÃ¢y! â˜ï¸ğŸŒ¸",
      "ChÃºc {name} {year} thÃ¢n khá»e â€“ tÃ¢m an â€“ trÃ­ sÃ¡ng! ğŸŒ¿ğŸ§ ",
      "NÄƒm {year} chÃºc {name} bÆ°á»›c nÃ o cÅ©ng cÃ³ ngÆ°á»i nÃ¢ng Ä‘á»¡! ğŸ¤âœ¨",
      "ChÃºc {name} {year} kiáº¿m Ä‘Æ°á»£c nhiá»u tiá»n nhÆ°ng váº«n ngá»§ Ä‘á»§ giáº¥c! ğŸ’¸ğŸ˜´",
      "NÄƒm {year} chÃºc {name} cÃ³ thÃªm nhiá»u tráº£i nghiá»‡m Ä‘Ã¡ng nhá»›! ğŸ—ºï¸âœ¨",
      "ChÃºc {name} {year} vui váº» trong Ä‘iá»u nhá», háº¡nh phÃºc trong Ä‘iá»u thÆ°á»ng! ğŸŒ·",
      "NÄƒm {year} chÃºc {name} má»i ná»— lá»±c Ä‘á»u Ä‘Æ°á»£c Ä‘á»n Ä‘Ã¡p xá»©ng Ä‘Ã¡ng! ğŸ†",
      "ChÃºc {name} {year} nÃ³i Ã­t trÃºng nhiá»u, lÃ m Ã­t hiá»‡u quáº£ cao! ğŸ˜†âœ…",
      "NÄƒm {year} chÃºc {name} gáº·p quÃ½ nhÃ¢n, trÃ¡nh tiá»ƒu nhÃ¢n! ğŸ§¿ğŸ€",
      "ChÃºc {name} {year} má»—i ngÃ y Ä‘á»u cÃ³ chÃºt â€œwowâ€! âœ¨ğŸ˜†",
      "NÄƒm {year} chÃºc {name} luÃ´n Ä‘Æ°á»£c trÃ¢n trá»ng vÃ  yÃªu thÆ°Æ¡ng Ä‘Ãºng cÃ¡ch! ğŸ’—",
      "ChÃºc {name} {year} bÃ¬nh an lÃ  chÃ­nh, vui váº» lÃ  nháº¥t! ğŸ•Šï¸",
      "NÄƒm {year} chÃºc {name} sá»‘ng nháº¹ nhÃ ng mÃ  váº«n rá»±c rá»¡! ğŸŒ¸ğŸŒŸ"
    ];

    // ===== People + session =====
    let PEOPLE = [];
    let selectedPerson = null;
    let lastWishIndex = -1;

    let session = { loggedIn:false, viewer:null, target:null };
    const firstWishShown = new Set(); // track firstWish per key

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function setStatus(msg, bad=false){
      statusEl.textContent = msg;
      statusEl.classList.toggle("bad", !!bad);
    }

    async function ensureServices(){
      // náº¿u services.js chÆ°a load => window.AppServices chÆ°a cÃ³
      if (!window.AppServices){
        throw new Error("AppServices chÆ°a sáºµn sÃ ng (services.js chÆ°a load hoáº·c lá»—i).");
      }
      await window.AppServices.initFirebaseIfNeeded?.();
    }

    function isOwnerRole(){
      return !!(session.loggedIn && session.viewer && session.viewer.role === "owner");
    }
    function isOwnerAuthed(){
      try{ return window.AppServices?.isOwnerAuthed?.() === true; }
      catch{ return false; }
    }
    function updateOwnerUI(){
      const ownerRole = isOwnerRole();
      const authed = isOwnerAuthed();
      btnOwnerLogin.classList.toggle("hidden", !ownerRole || authed);
      btnOwnerLogout.classList.toggle("hidden", !ownerRole || !authed);
      btnOwnerDashboard.classList.toggle("hidden", !ownerRole || !authed);
    }

    function openOwnerModal(){
      ownerModal.classList.remove("hidden");
      renderOwnerTab();
    }
    function closeOwnerModal(){
      ownerModal.classList.add("hidden");
    }

    function formatDuration(sec){
      sec = Math.max(0, Number(sec||0));
      const m = Math.floor(sec/60);
      const s = sec%60;
      if (m <= 0) return s + "s";
      return m + "m " + s + "s";
    }
    function fmtTime(ts){
      try{
        if (!ts) return "";
        if (typeof ts.toDate === "function") return ts.toDate().toLocaleString();
        if (ts.seconds) return new Date(ts.seconds*1000).toLocaleString();
        return new Date(ts).toLocaleString();
      }catch{ return ""; }
    }

    async function renderOwnerTab(){
      ownerBody.textContent = "Äang táº£i...";
      try{
        await ensureServices();
      }catch(e){
        ownerBody.innerHTML = `
          <div class="ownerRow">
            <div><b>âš ï¸ ${escapeHtml(e.message || "Lá»—i services")}</b></div>
            <div class="ownerMeta">Má»Ÿ DevTools â†’ Console/Network Ä‘á»ƒ xem file services.js cÃ³ bá»‹ 404 hoáº·c lá»—i JS khÃ´ng.</div>
          </div>`;
        return;
      }

      if (!isOwnerAuthed()){
        ownerBody.innerHTML = `
          <div class="ownerRow">
            <div><b>ğŸ” Báº¡n chÆ°a Ä‘Äƒng nháº­p Google Owner</b></div>
            <div class="ownerMeta">Báº¥m â€œOwner Loginâ€ á»Ÿ gÃ³c trÃªn Ä‘á»ƒ Ä‘Äƒng nháº­p.</div>
          </div>
        `;
        return;
      }

      try{
        if (ownerTab === "views"){
          const list = await window.AppServices.getLatestViews(200);
          const ownerKey = window.OWNER_KEY || "";
          const filtered = list.filter(v => (v.ownerKey||"") === ownerKey);
          if (!filtered.length){ ownerBody.textContent = "ChÆ°a cÃ³ lÆ°á»£t xem nÃ o."; return; }

          ownerBody.innerHTML = filtered.map(v => `
            <div class="ownerRow">
              <div class="ownerMeta">
                <span class="pillMini">ğŸ‘€ ${escapeHtml(v.viewerLabel || v.viewerKey || "áº¨n danh")}</span>
                xem thiá»‡p: <b>${escapeHtml(v.targetLabel || v.targetKey || "")}</b>
                â€¢ thá»i lÆ°á»£ng: <b>${formatDuration(v.durationSec || 0)}</b>
              </div>
              <div class="ownerMeta">
                Báº¯t Ä‘áº§u: ${escapeHtml(fmtTime(v.startedAt))}
                â€¢ Káº¿t thÃºc: ${escapeHtml(fmtTime(v.endedAt))}
              </div>
              <div class="ownerMeta">UA: ${escapeHtml(String(v.userAgent||"").slice(0,120))}</div>
            </div>
          `).join("");
        } else {
          const list = await window.AppServices.getLatestWishes(200);
          const ownerKey = window.OWNER_KEY || "";
          const filtered = list.filter(w => (w.ownerKey||"") === ownerKey);
          if (!filtered.length){ ownerBody.textContent = "ChÆ°a cÃ³ lá»i chÃºc nÃ o."; return; }

          ownerBody.innerHTML = filtered.map(w => `
            <div class="ownerRow">
              <div class="ownerMeta">
                <span class="pillMini">ğŸ’Œ ${escapeHtml(w.viewerLabel || w.viewerKey || "áº¨n danh")}</span>
                gá»­i khi Ä‘ang xem thiá»‡p: <b>${escapeHtml(w.targetLabel || w.targetKey || "")}</b>
                â€¢ ${escapeHtml(fmtTime(w.createdAt))}
              </div>
              <div style="white-space:pre-wrap">${escapeHtml(w.message || "")}</div>
            </div>
          `).join("");
        }
      }catch(e){
        console.warn(e);
        ownerBody.innerHTML = `
          <div class="ownerRow">
            <div><b>âš ï¸ KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u</b></div>
            <div class="ownerMeta">Kiá»ƒm tra Firestore Rules (owner-only read) hoáº·c Owner chÆ°a login.</div>
          </div>
        `;
      }
    }

    function randomWish(pool){
      let idx;
      do { idx = Math.floor(Math.random() * pool.length); }
      while (pool.length > 1 && idx === lastWishIndex);
      lastWishIndex = idx;
      return pool[idx];
    }

    function getDisplayNameForTarget(t){
      if (!t) return "báº¡n";
      const override = (t.nameOverride || "").trim();
      return override || t.label || "báº¡n";
    }

    function formatWish(template, displayName){
      const name = (displayName || "báº¡n").trim();
      const year = (yearInput.value || yearText.textContent || defaultYear).trim();
      return template.replaceAll("{name}", name).replaceAll("{year}", year);
    }

    function buildWishText(template, target){
      const name = getDisplayNameForTarget(target);
      let text = formatWish(template, name);
      const suffix = (target?.suffix || "").trim();
      if (suffix) text += " " + suffix;
      return text;
    }

    function getWishPoolForTarget(target){
      // default: random global
      if (!target) return GLOBAL_WISHES;

      // Náº¿u cÃ³ useGlobalRandomOnly => luÃ´n dÃ¹ng global khi báº¥m Ä‘á»•i
      if (target.useGlobalRandomOnly) return GLOBAL_WISHES;

      // Náº¿u ngÆ°á»i Ä‘Ã³ cÃ³ wishes riÃªng (vÃ­ dá»¥ owner) => dÃ¹ng riÃªng
      if (Array.isArray(target.wishes) && target.wishes.length) return target.wishes;

      return GLOBAL_WISHES;
    }

    function showRandomWish(){
      if (!session.loggedIn || !session.target) return;
      const pool = getWishPoolForTarget(session.target);
      const t = randomWish(pool);
      wishEl.textContent = buildWishText(t, session.target);
      burst(lastPointer.x || (innerWidth*0.5), lastPointer.y || (innerHeight*0.35), 120);
    }

    function showInitialWishIfAny(target){
      // chá»‰ show firstWish 1 láº§n cho má»—i key trong phiÃªn nÃ y
      if (!target?.firstWish) return false;
      if (firstWishShown.has(target.key)) return false;
      firstWishShown.add(target.key);

      wishEl.textContent = buildWishText(target.firstWish, target);
      return true;
    }

    function tryLoadAvatarFromCandidates(candidates){
      let i = 0;
      const tryNext = () => {
        if (i >= candidates.length){ avatarImg.src = "avatars/default.png"; return; }
        avatarImg.onerror = tryNext;
        avatarImg.src = candidates[i++];
      };
      tryNext();
    }
    function setAvatar(person){
      if (!person){ avatarImg.src = "avatars/default.png"; return; }
      const exts = person.exts || ["jpg","png","webp","jpeg"];
      const candidates = exts.map(ext => `avatars/${person.key}.${ext}`);
      tryLoadAvatarFromCandidates(candidates);
    }

    async function loadPeople(){
      const res = await fetch("avatars/people.json", { cache: "no-store" });
      if (!res.ok) throw new Error("Cannot load avatars/people.json");
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("people.json must be an array");

      PEOPLE = data.map(p => ({
        key: String(p.key || "").trim(),
        label: String(p.label || "").trim(),
        pass: String(p.pass || "").trim(),
        role: String(p.role || "guest").trim(),
        exts: Array.isArray(p.exts) ? p.exts : ["jpg","png","webp","jpeg"],

        // optional:
        wishes: Array.isArray(p.wishes) ? p.wishes : null,
        firstWish: p.firstWish ? String(p.firstWish) : "",
        useGlobalRandomOnly: !!p.useGlobalRandomOnly,
        suffix: p.suffix ? String(p.suffix) : "",
        nameOverride: p.nameOverride ? String(p.nameOverride) : ""
      })).filter(p => p.key && p.label && p.pass);
    }

    function openMenu(){
      menu.classList.remove("hidden");
      search.value = "";
      renderMenu("");
      setTimeout(() => search.focus(), 0);
    }
    function closeMenu(){ menu.classList.add("hidden"); }

    function renderMenu(q){
      const query = (q || "").trim().toLowerCase();
      const list = PEOPLE.filter(p =>
        p.label.toLowerCase().includes(query) || p.key.toLowerCase().includes(query)
      );
      menuList.innerHTML = list.map(p => `
        <div class="item" data-key="${p.key}">
          <div class="left">
            <div class="name">${escapeHtml(p.label)}</div>
            <div class="meta">@${escapeHtml(p.key)}</div>
          </div>
          <div class="tag">${p.role === "owner" ? "OWNER" : "GUEST"}</div>
        </div>
      `).join("") || `
        <div class="item">
          <div class="left">
            <div class="name">KhÃ´ng tÃ¬m tháº¥y</div>
            <div class="meta">Thá»­ gÃµ tÃªn hoáº·c key</div>
          </div>
        </div>`;
    }

    function pickPersonByKey(key){
      const p = PEOPLE.find(x => x.key === key);
      if (!p) return;
      selectedPerson = p;
      selectText.innerHTML = `<span>${escapeHtml(p.label)} <small>(@${escapeHtml(p.key)})</small></span>`;
      closeMenu();
      btnOwnerView.disabled = !(session.loggedIn && session.viewer && session.viewer.role === "owner");
    }

    selectBtn.addEventListener("click", () => {
      if (menu.classList.contains("hidden")) openMenu();
      else closeMenu();
    });
    search.addEventListener("input", () => renderMenu(search.value));
    menuList.addEventListener("click", (e) => {
      const item = e.target.closest(".item");
      if (!item) return;
      const key = item.getAttribute("data-key");
      if (key) pickPersonByKey(key);
    });
    document.addEventListener("click", (e) => {
      if (!selectWrap.contains(e.target)) closeMenu();
    });

    function lockCard(msg){
      session = { loggedIn:false, viewer:null, target:null };
      firstWishShown.clear();

      userChangedTrack = false;
      try{ music.pause(); }catch(e){}
      musicOn = false;
      setMusicButton(false);

      try{ window.AppServices?.stopView?.(); }catch(e){}

      lock.classList.remove("hidden");
      chip.textContent = "ChÆ°a má»Ÿ";
      badge.textContent = "ğŸ´ Thiá»‡p NÄƒm Má»›i â€¢ Pastel Cute";
      subLine.textContent = "Má»Ÿ khÃ³a xong báº¡n sáº½ tháº¥y lá»i chÃºc dÃ nh riÃªng cho báº¡n ğŸ";

      viewerName.value = "";
      viewerName.disabled = true;
      btnWish.disabled = true;

      btnSendWish.disabled = true;
      wishMsg.value = "";
      wishMsg.disabled = true;

      updateOwnerUI();

      wishEl.textContent = "ğŸ”’ Thiá»‡p Ä‘ang khÃ³a. HÃ£y má»Ÿ thiá»‡p Ä‘á»ƒ xem lá»i chÃºc.";
      avatarImg.src = "avatars/default.png";

      btnOwnerView.disabled = true;
      btnLogout.classList.add("hidden");
      setStatus(msg || "ğŸ‘‰ Chá»n ngÆ°á»i + nháº­p máº­t kháº©u Ä‘á»ƒ báº¯t Ä‘áº§u.", false);
    }

    function applySessionUI(){
      const v = session.viewer;
      const t = session.target;

      chip.textContent = v.role === "owner" ? "ÄÃ£ má»Ÿ â€¢ Owner" : "ÄÃ£ má»Ÿ";
      badge.textContent = v.role === "owner" ? "ğŸ‘‘ Owner Mode â€¢ Pastel Cute" : "ğŸ´ Thiá»‡p NÄƒm Má»›i â€¢ Pastel Cute";

      viewerName.value = t.label;
      viewerName.disabled = true;

      btnWish.disabled = false;
      btnOwnerView.disabled = !(v.role === "owner" && selectedPerson);
      btnLogout.classList.remove("hidden");

      subLine.textContent = (v.role === "owner")
        ? "ğŸ‘‘ Owner: cÃ³ thá»ƒ xem thiá»‡p ngÆ°á»i khÃ¡c (khÃ´ng cáº§n máº­t kháº©u cá»§a há»)."
        : "ChÃºc báº¡n má»™t nÄƒm má»›i rá»±c rá»¡ vÃ  tháº­t bÃ¬nh an ğŸŒ¸";

      setAvatar(t);

      // âœ… náº¿u ngÆ°á»i nÃ y cÃ³ firstWish thÃ¬ show khi má»Ÿ láº§n Ä‘áº§u
      const didShowFirst = showInitialWishIfAny(t);
      if (!didShowFirst){
        // khÃ´ng cÃ³ firstWish => random bÃ¬nh thÆ°á»ng
        const pool = getWishPoolForTarget(t);
        const template = randomWish(pool);
        wishEl.textContent = buildWishText(template, t);
      }

      lock.classList.add("hidden");

      btnSendWish.disabled = false;
      wishMsg.disabled = false;

      try{ window.AppServices?.startView?.(session.viewer, session.target); }catch(e){}
      updateOwnerUI();
      burst(innerWidth*0.5, innerHeight*0.28, 180);
    }

    btnUnlock.addEventListener("click", () => {
      if (!selectedPerson){ setStatus("âŒ Báº¡n chÆ°a chá»n ngÆ°á»i.", true); return; }
      const pw = (pass.value || "").trim();
      if (!pw){ setStatus("âš ï¸ Báº¡n chÆ°a nháº­p máº­t kháº©u.", true); return; }
      if (pw !== selectedPerson.pass){
        setAvatar(selectedPerson);
        setStatus("âŒ Sai máº­t kháº©u. Thá»­ láº¡i nha!", true);
        return;
      }
      session.loggedIn = true;
      session.viewer = selectedPerson;
      session.target = selectedPerson;
      setStatus("âœ… Má»Ÿ thiá»‡p thÃ nh cÃ´ng! ğŸ‰", false);
      applySessionUI();
    });

    btnOwnerView.addEventListener("click", () => {
      if (!session.loggedIn || !session.viewer || session.viewer.role !== "owner"){
        setStatus("âŒ Chá»‰ Owner má»›i dÃ¹ng Ä‘Æ°á»£c.", true);
        return;
      }
      if (!selectedPerson){ setStatus("âš ï¸ Chá»n ngÆ°á»i cáº§n xem trÆ°á»›c Ä‘Ã£.", true); return; }
      session.target = selectedPerson;
      applySessionUI();
    });

    btnLogout.addEventListener("click", () => lockCard("ğŸ‘‹ ÄÃ£ Ä‘Äƒng xuáº¥t."));

    // Owner Login/Logout/Dashboard
    btnOwnerLogin.addEventListener("click", async () => {
      try{
        await ensureServices();
        const info = await window.AppServices.ownerGoogleLogin();
        alert("âœ… Owner Google Login OK\nUID: " + (info.uid || "") + "\nEmail: " + (info.email || ""));
      }catch(e){
        console.warn(e);
        alert("âŒ Owner login lá»—i.\nMsg: " + (e.message || e) +
          "\n\nNáº¿u lÃ  auth/unauthorized-domain: Firebase Console â†’ Authentication â†’ Settings â†’ Authorized domains â†’ Add: mangniemvui.github.io");
      }finally{
        updateOwnerUI();
      }
    });

    btnOwnerLogout.addEventListener("click", async () => {
      try{ await window.AppServices.ownerGoogleLogout(); }catch(e){}
      updateOwnerUI();
    });

    btnOwnerDashboard.addEventListener("click", () => openOwnerModal());
    btnCloseOwner.addEventListener("click", closeOwnerModal);
    ownerModal.addEventListener("click", (e) => { if (e.target === ownerModal) closeOwnerModal(); });

    btnTabViews.addEventListener("click", () => { ownerTab = "views"; renderOwnerTab(); });
    btnTabWishes.addEventListener("click", () => { ownerTab = "wishes"; renderOwnerTab(); });
    btnRefreshOwner.addEventListener("click", () => renderOwnerTab());

    // Send wish to owner (Firestore + EmailJS)
    btnSendWish.addEventListener("click", async () => {
      const message = (wishMsg.value || "").trim();
      if (!message){
        setStatus("âš ï¸ Báº¡n chÆ°a nháº­p lá»i chÃºc.", true);
        return;
      }
      try{
        btnSendWish.disabled = true;
        await ensureServices();
        const result = await window.AppServices.sendWish({
          viewerKey: session.viewer?.key || "",
          viewerLabel: session.viewer?.label || "",
          targetKey: session.target?.key || "",
          targetLabel: session.target?.label || "",
          message
        });
        wishMsg.value = "";
        if (result && result.emailed){
          setStatus("âœ… ÄÃ£ gá»­i email Ä‘áº¿n Gmail chá»§ sá»Ÿ há»¯u! ğŸ’Œ", false);
        }else if (result && result.savedToFirestore){
          setStatus("âœ… ÄÃ£ lÆ°u lá»i chÃºc (chÆ°a gá»­i email vÃ¬ chÆ°a cáº¥u hÃ¬nh EmailJS).", false);
        }else{
          setStatus("âœ… ÄÃ£ gá»­i! (HÃ£y kiá»ƒm tra cáº¥u hÃ¬nh EmailJS/Firebase).", false);
        }
      }catch(e){
        console.warn(e);
        setStatus("âš ï¸ Gá»­i tháº¥t báº¡i. Kiá»ƒm tra EmailJS/Firebase vÃ  Console (F12).", true);
      }finally{
        btnSendWish.disabled = false;
      }
    });

    btnWish.addEventListener("click", showRandomWish);
    btnHint.addEventListener("click", () => {
      setStatus("Tip: áº¢nh pháº£i Ä‘áº·t Ä‘Ãºng key. VÃ­ dá»¥: avatars/bethucute.jpg + báº¯t buá»™c cÃ³ avatars/default.png", false);
    });

    // ===== fireworks =====
    const canvas = document.getElementById("fx");
    const ctx = canvas.getContext("2d", { alpha: true });
    let W = 0, H = 0, dpr = 1;
    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      W = Math.floor(window.innerWidth);
      H = Math.floor(window.innerHeight);
      canvas.width = Math.floor(W * dpr);
      canvas.height = Math.floor(H * dpr);
      canvas.style.width = W + "px";
      canvas.style.height = H + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resize, { passive:true });
    resize();

    const particles = [];
    const rockets = [];
    const gravity = 0.065;
    const palette = [
      [255, 122, 182],[126, 231, 255],[255, 231, 153],
      [197, 163, 255],[170, 255, 200],[255, 255, 255]
    ];
    function rand(min, max){ return Math.random() * (max - min) + min; }

    function addRocket(x, y){
      rockets.push({
        x, y: H + 20, tx: x, ty: y,
        vx: rand(-0.5, 0.5),
        vy: rand(-10.2, -8.4),
        life: 0,
        color: palette[(Math.random()*palette.length)|0],
      });
    }
    function burst(x, y, count = 90){
      const col = palette[(Math.random()*palette.length)|0];
      for (let i=0;i<count;i++){
        const a = Math.random() * Math.PI * 2;
        const sp = rand(1.1, 5.0);
        particles.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          r: rand(1.2, 2.6),
          drag: rand(0.985, 0.993),
          alpha: 1,
          fade: rand(0.010, 0.018),
          col,
          sparkle: Math.random() < 0.28
        });
      }
    }
    function drawGlow(x, y, r, col, a){
      ctx.beginPath();
      ctx.fillStyle = `rgba(${col[0]},${col[1]},${col[2]},${a})`;
      ctx.arc(x, y, r, 0, Math.PI*2);
      ctx.fill();
    }
    function fadeFrame(){
      ctx.fillStyle = "rgba(255,255,255,0.10)";
      ctx.fillRect(0, 0, W, H);
    }

    let lastPointer = {x: W*0.5, y: H*0.35};
    function pointerPos(e){
      if (e.touches && e.touches[0]) return {x: e.touches[0].clientX, y: e.touches[0].clientY};
      return {x: e.clientX, y: e.clientY};
    }
    window.addEventListener("pointerdown", (e) => {
      const p = pointerPos(e);
      lastPointer = p;
      addRocket(p.x, p.y);
    }, { passive:true });
    window.addEventListener("touchstart", (e) => {
      const p = pointerPos(e);
      lastPointer = p;
      addRocket(p.x, p.y);
    }, { passive:true });

    const autoEl = document.getElementById("auto");
    function step(){
      fadeFrame();

      if (autoEl.checked && Math.random() < (session.loggedIn ? 0.06 : 0.035)){
        addRocket(rand(W*0.12, W*0.88), rand(H*0.10, session.loggedIn ? H*0.55 : H*0.45));
      }

      for (let i=rockets.length-1;i>=0;i--){
        const r = rockets[i];
        r.life++;
        r.x += r.vx; r.y += r.vy;
        r.vy += gravity * 0.35;

        drawGlow(r.x, r.y, 2.2, r.color, 0.60);
        drawGlow(r.x, r.y, 7.2, r.color, 0.16);

        if (r.y <= r.ty || r.vy > -2.2 || r.life > 85){
          burst(r.x, r.y, (session.loggedIn ? 95 : 70) + ((Math.random()*60)|0));
          rockets.splice(i, 1);
        }
      }

      for (let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.vx *= p.drag; p.vy *= p.drag;
        p.vy += gravity;
        p.x += p.vx; p.y += p.vy;

        p.alpha -= p.fade;
        if (p.alpha <= 0 || p.y > H+40 || p.x < -40 || p.x > W+40){
          particles.splice(i, 1);
          continue;
        }
        const flick = p.sparkle ? (0.6 + Math.random()*0.7) : 1;
        drawGlow(p.x, p.y, p.r * flick, p.col, Math.max(0, p.alpha));
        drawGlow(p.x, p.y, p.r * 3.4, p.col, Math.max(0, p.alpha)*0.10);
      }

      requestAnimationFrame(step);
    }

    // ===== init =====
    (async function init(){
      try{
        await loadPeople();
        renderMenu("");
        if (PEOPLE.length){
          selectedPerson = PEOPLE[0];
          selectText.innerHTML = `<span>${escapeHtml(selectedPerson.label)} <small>(@${escapeHtml(selectedPerson.key)})</small></span>`;
        }
        lockCard("ğŸ‘‰ Chá»n ngÆ°á»i + nháº­p máº­t kháº©u Ä‘á»ƒ báº¯t Ä‘áº§u.");
      }catch(err){
        console.warn(err);
        lockCard("âš ï¸ KhÃ´ng táº£i Ä‘Æ°á»£c people.json. Kiá»ƒm tra: avatars/people.json");
      }
      await loadPlaylist();

      ctx.clearRect(0,0,W,H);
      step();
      setTimeout(() => burst(W*0.5, H*0.28, 90), 350);
      try{ updateOwnerUI(); }catch(e){}
    })();
  </script>
</body>
</html>
